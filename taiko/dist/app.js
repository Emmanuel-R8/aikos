var C0=5603,s0=512,b=512;var n=65536,W0=10,$0=20,U0=40960;var d0=32768;var I0=32,G=0,v=1,E=3758096384,R0=3221225472,v0=3758096384,X0=268435455;var o0=2883584,r0=655360,t0=786432,a0=196608,m0=1314816;class k0{static lispPtrToByte($){return $*2}static byteToLispPtr($){return Math.floor($/2)}static getVirtualPage($){return Math.floor($/b)}static getPageOffset($){return $%b}static getVirtualAddressBase($){return $*b}}class b0{static getFilePageForVirtualPage($,q){for(let Q=0;Q<$.length;Q++)if(($[Q]&65535)===q)return Q;return null}static getPageOK($,q){if(q<$.length)return $[q]>>16&65535;return 0}static getFileOffset($){return $*512}static getVirtualPage($){return $&65535}static getPageStatus($){return $>>16&65535}}class T{static needsByteSwap($,q){let Q=Math.floor(q/4)+1;return $<Q}static swapU32($){return($&255)<<24|($&65280)<<8|($&16711680)>>8|($&4278190080)>>>24}static swapU16($){return($&255)<<8|($&65280)>>8}static applyXorAddressing($){return $^3}static readWordXor($,q){let Q=q^3,j=q+1^3,W=Q<$.length?$[Q]:0,X=j<$.length?$[j]:0;return W|X<<8}static readWordLittleEndian($,q){let Q=q<$.length?$[q]:0,j=q+1<$.length?$[q+1]:0;return Q|j<<8}static readByteXor($,q){if(q<$.length){let Q=q^3;if(Q<$.length)return $[Q]}return null}}class e0{static readByte($,q){if(q>=0&&q<$.length)return $[q];return null}static readByteXor($,q){return T.readByteXor($,q)}static readInstructionBytes($,q,Q){let j=Math.min(q+Q,$.length);if(q<j&&q>=0)return $.slice(q,j);return new Uint8Array(0)}static readDLword($,q){if(q>=0&&q+1<$.length)return $[q]|$[q+1]<<8;return 0}static readDLwordXor($,q){return T.readWordXor($,q)}static readLispPTR($,q){let Q=this.readDLword($,q);return this.readDLword($,q+2)<<16|Q}static writeByte($,q,Q){if(q>=0&&q<$.length)$[q]=Q&255}static writeDLword($,q,Q){if(q>=0&&q+1<$.length)$[q]=Q&255,$[q+1]=Q>>8&255}static writeLispPTR($,q,Q){this.writeDLword($,q,Q&65535),this.writeDLword($,q+2,Q>>16&65535)}static readJumpOffset($,q){return T.readWordXor($,q+1)<<16>>16}static readJumpOffsetRaw($,q){return T.readWordLittleEndian($,q+1)<<16>>16}}class U{static Address=k0;static FPtoVP=b0;static Endianness={needsByteSwap:T.needsByteSwap,swapU32:T.swapU32,swapU16:T.swapU16,applyXorAddressing:T.applyXorAddressing,readWordXor:T.readWordXor,readWordLittleEndian:T.readWordLittleEndian,readByteXor:T.readByteXor,getXorAddress:($)=>T.applyXorAddressing($)};static Access=e0}class E0{stackBase;stackPtr;stackEnd;currentFrame=null;virtualMemory=null;fptovpTable=null;atomSpaceOffset=0;defSpaceOffset=0;valSpaceOffset=0;plistSpaceOffset=0;dtdOffset=0;pc=0;returnPc=null;funcObj=null;pvar=null;ivar=null;topOfStack=0;cstkptrl=null;stopRequested=!1;running=!1;totalInstructionCount=0;stepCapActive=!1;maxSteps=null;displayRegion=null;displayWidth=0;displayHeight=0;displayRegionOffset=0;constructor($=65536){this.stackBase=n*2,this.stackPtr=this.stackBase,this.stackEnd=this.stackBase-$}initializeMemory($,q,Q,j,W,X,K){this.virtualMemory=$,this.fptovpTable=q,this.atomSpaceOffset=Q,this.defSpaceOffset=j,this.valSpaceOffset=W,this.plistSpaceOffset=X,this.dtdOffset=K}initializeDisplay($,q,Q){if(this.displayWidth=q,this.displayHeight=Q,this.displayRegionOffset=U.Address.lispPtrToByte($),this.virtualMemory&&this.displayRegionOffset<this.virtualMemory.length){let j=Math.floor(q*Q/16),W=this.displayRegionOffset+j*2;if(W<=this.virtualMemory.length){let X=this.virtualMemory.buffer.slice(this.virtualMemory.byteOffset+this.displayRegionOffset,this.virtualMemory.byteOffset+W);this.displayRegion=new Uint16Array(X)}}}getDisplayRegion(){return this.displayRegion}getStackPtrOffset(){if(this.virtualMemory===null)return 0;let $=this.stackPtr,Q=this.stackBase-$;return Math.floor(Q/2)}getFramePtrOffset(){if(this.currentFrame===null)return 0;return this.getStackPtrOffset()}readTopOfStackFromMemory(){if(this.virtualMemory===null||this.cstkptrl===null)return 0;let $=this.cstkptrl-4;if($>=0&&$+4<=this.virtualMemory.length){let q=this.virtualMemory[$]|this.virtualMemory[$+1]<<8;return(this.virtualMemory[$+2]|this.virtualMemory[$+3]<<8)<<16|q}return 0}initCSTKPTRLFromCurrentStackPTR(){this.cstkptrl=this.stackPtr}syncTopOfStack(){this.topOfStack=this.readTopOfStackFromMemory()}reset(){this.pc=0,this.returnPc=null,this.stopRequested=!1,this.running=!1,this.totalInstructionCount=0,this.topOfStack=0,this.cstkptrl=null,this.currentFrame=null,this.funcObj=null,this.pvar=null,this.ivar=null,this.stackPtr=this.stackBase}}var I;((J)=>{J[J.NIL=104]="NIL";J[J.T=105]="T";J[J.CONST_0=106]="CONST_0";J[J.CONST_1=107]="CONST_1";J[J.ACONST=103]="ACONST";J[J.SIC=108]="SIC";J[J.SNIC=109]="SNIC";J[J.SICX=110]="SICX";J[J.GCONST=111]="GCONST";J[J.FN0=8]="FN0";J[J.FN1=9]="FN1";J[J.FN2=10]="FN2";J[J.FN3=11]="FN3";J[J.FN4=12]="FN4";J[J.FNX=13]="FNX";J[J.APPLYFN=14]="APPLYFN";J[J.CHECKAPPLY=15]="CHECKAPPLY";J[J.RETURN=16]="RETURN";J[J.BIND=17]="BIND";J[J.UNBIND=18]="UNBIND";J[J.DUNBIND=19]="DUNBIND";J[J.RPLPTR_N=20]="RPLPTR_N";J[J.GCREF=21]="GCREF";J[J.ASSOC=22]="ASSOC";J[J.GVAR_=23]="GVAR_";J[J.CAR=1]="CAR";J[J.CDR=2]="CDR";J[J.NTYPX=4]="NTYPX";J[J.CONS=26]="CONS";J[J.CMLASSOC=27]="CMLASSOC";J[J.FMEMB=28]="FMEMB";J[J.CMLMEMBER=29]="CMLMEMBER";J[J.FINDKEY=30]="FINDKEY";J[J.CREATECELL=31]="CREATECELL";J[J.WRTPTRTAG=54]="WRTPTRTAG";J[J.BIN=32]="BIN";J[J.BOUT=33]="BOUT";J[J.RPLCONS=38]="RPLCONS";J[J.LISTGET=39]="LISTGET";J[J.ELT=40]="ELT";J[J.NTHCHC=41]="NTHCHC";J[J.SETA=42]="SETA";J[J.RPLCHARCODE=43]="RPLCHARCODE";J[J.EVAL=44]="EVAL";J[J.ENVCALL=45]="ENVCALL";J[J.TYPECHECK=46]="TYPECHECK";J[J.BUSBLT=48]="BUSBLT";J[J.MISC8=49]="MISC8";J[J.UBFLOAT3=50]="UBFLOAT3";J[J.RPLACA=24]="RPLACA";J[J.RPLACD=25]="RPLACD";J[J.TYPEP=5]="TYPEP";J[J.DTEST=6]="DTEST";J[J.UNWIND=7]="UNWIND";J[J.MISCN=36]="MISCN";J[J.POPDISP=34]="POPDISP";J[J.RESTLIST=35]="RESTLIST";J[J.GVAR=96]="GVAR";J[J.ARG0=97]="ARG0";J[J.PVARX_=95]="PVARX_";J[J.IVARX_=98]="IVARX_";J[J.FVARX_=99]="FVARX_";J[J.POP=191]="POP";J[J.POP_N=192]="POP_N";J[J.ATOMCELL_N=193]="ATOMCELL_N";J[J.GETBASEBYTE=194]="GETBASEBYTE";J[J.INSTANCEP=195]="INSTANCEP";J[J.BLT=196]="BLT";J[J.MISC10=197]="MISC10";J[J.PUTBASEBYTE=199]="PUTBASEBYTE";J[J.GETBASE_N=200]="GETBASE_N";J[J.ITIMES2=201]="ITIMES2";J[J.GETBITS_N_FD=202]="GETBITS_N_FD";J[J.PUTBASE_N=205]="PUTBASE_N";J[J.PUTBASEPTR_N=206]="PUTBASEPTR_N";J[J.PUTBITS_N_FD=207]="PUTBITS_N_FD";J[J.ADDBASE=208]="ADDBASE";J[J.VAG2=209]="VAG2";J[J.HILOC=210]="HILOC";J[J.LOLOC=211]="LOLOC";J[J.PLUS2=212]="PLUS2";J[J.DIFFERENCE=213]="DIFFERENCE";J[J.TIMES2=214]="TIMES2";J[J.QUOTIENT=215]="QUOTIENT";J[J.CMLEQUAL=204]="CMLEQUAL";J[J.IPLUS2=216]="IPLUS2";J[J.IDIFFERENCE=217]="IDIFFERENCE";J[J.LLSH8=218]="LLSH8";J[J.IQUOTIENT=219]="IQUOTIENT";J[J.IREMAINDER=220]="IREMAINDER";J[J.IPLUS_N=221]="IPLUS_N";J[J.IDIFFERENCE_N=222]="IDIFFERENCE_N";J[J.BASE_LESSTHAN=223]="BASE_LESSTHAN";J[J.LLSH1=224]="LLSH1";J[J.LRSH1=226]="LRSH1";J[J.LRSH8=227]="LRSH8";J[J.LOGOR2=228]="LOGOR2";J[J.LOGAND2=229]="LOGAND2";J[J.LOGXOR2=230]="LOGXOR2";J[J.LSH=231]="LSH";J[J.GETBASEPTR_N=236]="GETBASEPTR_N";J[J.AREF2=238]="AREF2";J[J.UBFLOAT1=237]="UBFLOAT1";J[J.UBFLOAT2=225]="UBFLOAT2";J[J.FPLUS2=232]="FPLUS2";J[J.FDIFFERENCE=233]="FDIFFERENCE";J[J.FTIMES2=234]="FTIMES2";J[J.FQUOTIENT=235]="FQUOTIENT";J[J.ASET2=239]="ASET2";J[J.TYPEMASK_N=51]="TYPEMASK_N";J[J.MISC7=56]="MISC7";J[J.EQL=58]="EQL";J[J.DRAWLINE=59]="DRAWLINE";J[J.STORE_N=60]="STORE_N";J[J.RAID=62]="RAID";J[J.COPY_N=61]="COPY_N";J[J.RECLAIMCELL=122]="RECLAIMCELL";J[J.GCSCAN1=123]="GCSCAN1";J[J.GCSCAN2=124]="GCSCAN2";J[J.CONTEXTSWITCH=126]="CONTEXTSWITCH";J[J.RETCALL=127]="RETCALL";J[J.FGREATERP=242]="FGREATERP";J[J.IGREATERP=241]="IGREATERP";J[J.GREATERP=243]="GREATERP";J[J.EQ=240]="EQ";J[J.EQUAL=244]="EQUAL";J[J.MAKENUMBER=245]="MAKENUMBER";J[J.BOXIPLUS=246]="BOXIPLUS";J[J.BOXIDIFFERENCE=247]="BOXIDIFFERENCE";J[J.FLOATBLT=248]="FLOATBLT";J[J.FFTSTEP=249]="FFTSTEP";J[J.MISC3=250]="MISC3";J[J.MISC4=251]="MISC4";J[J.UPCTRACE=252]="UPCTRACE";J[J.CL_EQUAL=255]="CL_EQUAL";J[J.SWAP=253]="SWAP";J[J.NOP=254]="NOP";J[J.JUMP0=128]="JUMP0";J[J.JUMP1=129]="JUMP1";J[J.JUMP2=130]="JUMP2";J[J.JUMP3=131]="JUMP3";J[J.JUMP4=132]="JUMP4";J[J.JUMP5=133]="JUMP5";J[J.JUMP6=134]="JUMP6";J[J.JUMP7=135]="JUMP7";J[J.JUMP8=136]="JUMP8";J[J.JUMP9=137]="JUMP9";J[J.JUMP10=138]="JUMP10";J[J.JUMP11=139]="JUMP11";J[J.JUMP12=140]="JUMP12";J[J.JUMP13=141]="JUMP13";J[J.JUMP14=142]="JUMP14";J[J.JUMP15=143]="JUMP15";J[J.FJUMP0=144]="FJUMP0";J[J.FJUMP1=145]="FJUMP1";J[J.FJUMP2=146]="FJUMP2";J[J.FJUMP3=147]="FJUMP3";J[J.FJUMP4=148]="FJUMP4";J[J.FJUMP5=149]="FJUMP5";J[J.FJUMP6=150]="FJUMP6";J[J.FJUMP7=151]="FJUMP7";J[J.FJUMP8=152]="FJUMP8";J[J.FJUMP9=153]="FJUMP9";J[J.FJUMP10=154]="FJUMP10";J[J.FJUMP11=155]="FJUMP11";J[J.FJUMP12=156]="FJUMP12";J[J.FJUMP13=157]="FJUMP13";J[J.FJUMP14=158]="FJUMP14";J[J.FJUMP15=159]="FJUMP15";J[J.TJUMP0=160]="TJUMP0";J[J.TJUMP1=161]="TJUMP1";J[J.TJUMP2=162]="TJUMP2";J[J.TJUMP3=163]="TJUMP3";J[J.TJUMP4=164]="TJUMP4";J[J.TJUMP5=165]="TJUMP5";J[J.TJUMP6=166]="TJUMP6";J[J.TJUMP7=167]="TJUMP7";J[J.TJUMP8=168]="TJUMP8";J[J.TJUMP9=169]="TJUMP9";J[J.TJUMP10=170]="TJUMP10";J[J.TJUMP11=171]="TJUMP11";J[J.TJUMP12=172]="TJUMP12";J[J.TJUMP13=173]="TJUMP13";J[J.TJUMP14=174]="TJUMP14";J[J.TJUMP15=175]="TJUMP15";J[J.JUMPX=176]="JUMPX";J[J.JUMPXX=177]="JUMPXX";J[J.FJUMPX=178]="FJUMPX";J[J.TJUMPX=179]="TJUMPX";J[J.NFJUMPX=180]="NFJUMPX";J[J.NTJUMPX=181]="NTJUMPX";J[J.AREF1=182]="AREF1";J[J.ASET1=183]="ASET1";J[J.PVARSETPOP0=184]="PVARSETPOP0";J[J.PVARSETPOP1=185]="PVARSETPOP1";J[J.PVARSETPOP2=186]="PVARSETPOP2";J[J.PVARSETPOP3=187]="PVARSETPOP3";J[J.PVARSETPOP4=188]="PVARSETPOP4";J[J.PVARSETPOP5=189]="PVARSETPOP5";J[J.PVARSETPOP6=190]="PVARSETPOP6";J[J.IVAR0=64]="IVAR0";J[J.IVAR1=65]="IVAR1";J[J.IVAR2=66]="IVAR2";J[J.IVAR3=67]="IVAR3";J[J.IVAR4=68]="IVAR4";J[J.IVAR5=69]="IVAR5";J[J.IVAR6=70]="IVAR6";J[J.IVARX=71]="IVARX";J[J.PVAR0=72]="PVAR0";J[J.PVAR1=73]="PVAR1";J[J.PVAR2=74]="PVAR2";J[J.PVAR3=75]="PVAR3";J[J.PVAR4=76]="PVAR4";J[J.PVAR5=77]="PVAR5";J[J.PVAR6=78]="PVAR6";J[J.PVARX=79]="PVARX";J[J.FVAR0=80]="FVAR0";J[J.FVAR1=81]="FVAR1";J[J.FVAR2=82]="FVAR2";J[J.FVAR3=83]="FVAR3";J[J.FVAR4=84]="FVAR4";J[J.FVAR5=85]="FVAR5";J[J.FVAR6=86]="FVAR6";J[J.FVARX=87]="FVARX";J[J.PVAR_0=88]="PVAR_0";J[J.PVAR_1=89]="PVAR_1";J[J.PVAR_2=90]="PVAR_2";J[J.PVAR_3=91]="PVAR_3";J[J.PVAR_4=92]="PVAR_4";J[J.PVAR_5=93]="PVAR_5";J[J.PVAR_6=94]="PVAR_6";J[J.COPY=100]="COPY";J[J.MYARGCOUNT=101]="MYARGCOUNT";J[J.MYALINK=102]="MYALINK";J[J.STKSCAN=47]="STKSCAN";J[J.SLRETURN=63]="SLRETURN"})(I||={});function $$($){if($>=128&&$<=143)return 1;if($>=144&&$<=159)return 1;if($>=160&&$<=175)return 1;if($===176||$===178||$===179||$===180||$===181)return 3;if($===177)return 5;if($===20||$===5||$===23||$===21||$===22||$===35)return 2;if($===6||$===7)return 3;return 1}function J$($){if($ in I)return $;return null}function q$($,q){if($.virtualMemory===null)return null;let Q=$.virtualMemory,j=q^3;if(q>=Q.length)return console.error(`decodeInstructionFromMemory: PC=0x${q.toString(16)} out of bounds (memory length=0x${Q.length.toString(16)})`),null;if(j>=Q.length)return console.error(`decodeInstructionFromMemory: XOR address=0x${j.toString(16)} out of bounds (memory length=0x${Q.length.toString(16)})`),console.error("decodeInstructionFromMemory: Sparse page detected - code page not loaded"),console.error(`decodeInstructionFromMemory: Execution stopped at PC=0x${q.toString(16)} - sparse page encountered`),null;let W=Math.floor(j/512)*512,X=Math.min(W+512,Q.length);if(X>W){if(Q.slice(W,X).every((L)=>L===0))return console.error(`decodeInstructionFromMemory: Page at 0x${W.toString(16)} is sparse (all zeros)`),console.error(`decodeInstructionFromMemory: Execution stopped at PC=0x${q.toString(16)} - sparse page encountered`),null}let K=U.Access.readByteXor(Q,q);if(K===null)return console.error(`decodeInstructionFromMemory: Failed to read opcode byte at PC=0x${q.toString(16)}, XOR addr=0x${j.toString(16)}`),console.error(`decodeInstructionFromMemory: Raw byte at PC=0x${Q[q]?.toString(16)??"undefined"}, at XOR addr=0x${Q[j]?.toString(16)??"undefined"}`),null;let Y=J$(K);if(Y===null)return console.error(`decodeInstructionFromMemory: Unknown opcode 0x${K.toString(16)} at PC=0x${q.toString(16)} (XOR addr=0x${j.toString(16)}, raw byte=0x${Q[j]?.toString(16)??"undefined"})`),null;let B=$$(Y);if(q+B>Q.length)return null;let w=new Uint8Array(Math.max(0,B-1));for(let V=0;V<w.length;V++){let H=q+V+1,L=U.Access.readByteXor(Q,H);if(L===null)return null;w[V]=L}return{opcode:Y,operands:w,length:B}}var Q$=new Map;function z($,q){Q$.set($,q)}function E$($){return Q$.get($)??null}function j$($,q){let Q=E$(q.opcode);if(Q)return Q($,q);return null}function Z($,q){if($.virtualMemory===null)return;if($.cstkptrl===null)$.cstkptrl=$.stackBase-4;else $.cstkptrl-=4;if($.cstkptrl>=0&&$.cstkptrl+4<=$.virtualMemory.length)U.Access.writeLispPTR($.virtualMemory,$.cstkptrl,q);$.topOfStack=q,$.stackPtr=$.cstkptrl}function D($){if($.virtualMemory===null)return 0;if($.cstkptrl===null)return $.topOfStack=0,$.stackPtr=$.stackBase,0;let q=0;if($.cstkptrl>=0&&$.cstkptrl+4<=$.virtualMemory.length)q=U.Access.readLispPTR($.virtualMemory,$.cstkptrl);if($.cstkptrl===$.stackBase-4)$.cstkptrl=null,$.stackPtr=$.stackBase,$.topOfStack=0;else if($.cstkptrl+=4,$.stackPtr=$.cstkptrl,$.cstkptrl>=0&&$.cstkptrl+4<=$.virtualMemory.length)$.topOfStack=U.Access.readLispPTR($.virtualMemory,$.cstkptrl);else $.topOfStack=0;return q}function T$($,q){return Z($,0),null}function _$($,q){return Z($,1),null}function P$($,q){return Z($,0),null}function M$($,q){return Z($,1),null}function h$($,q){if($.virtualMemory===null)return null;let Q=U.Access.readByteXor($.virtualMemory,$.pc+1);if(Q===null)return null;let W=14680064|Q;return Z($,W),null}z(104,T$);z(105,_$);z(106,P$);z(107,M$);z(103,h$);function S$($,q){return D($),null}function y$($,q){if($.virtualMemory===null)return null;let Q=U.Access.readByteXor($.virtualMemory,$.pc+1);if(Q===null)return null;let j=Q;for(let W=0;W<j;W++)D($);return null}function u$($,q){if($.virtualMemory===null)return null;let Q=$.topOfStack,j=$.cstkptrl-4;if(j<0||j+4>$.virtualMemory.length)return null;let W=U.Access.readLispPTR($.virtualMemory,j);return $.topOfStack=W,U.Access.writeLispPTR($.virtualMemory,j,Q),null}function g$($,q){return null}z(191,S$);z(192,y$);z(253,u$);z(254,g$);function h($){return($&E)===E}function S($){return $&65535}function V0($){return(E|$&65535)>>>0}function T0($){let q=D($),Q=$.topOfStack;if(h(Q)&&h(q)){let j=S(Q),W=S(q),X=j+W;$.topOfStack=V0(X)}else $.topOfStack=Q+q&16777215;return $.topOfStack}function _0($){let q=D($),Q=$.topOfStack;if(h(Q)&&h(q)){let j=S(Q),X=S(q)-j;$.topOfStack=V0(X)}else $.topOfStack=q-Q&16777215;return $.topOfStack}function P0($){let q=D($),Q=$.topOfStack;if(h(Q)&&h(q)){let j=S(Q),W=S(q),X=j*W;$.topOfStack=V0(X)}else $.topOfStack=Q*q&16777215;return $.topOfStack}function W$($){let q=D($),Q=$.topOfStack;if(h(Q)&&h(q)){let j=S(Q),W=S(q);if(W===0)$.topOfStack=0;else{let X=Math.floor(j/W);$.topOfStack=V0(X)}}else $.topOfStack=0;return $.topOfStack}function U$($){return T0($)}function X$($){return _0($)}function Z$($){return P0($)}function l$($,q){return T0($),null}function i$($,q){return _0($),null}function n$($,q){return P0($),null}function O$($,q){return W$($),null}function f$($,q){return U$($),null}function c$($,q){return X$($),null}function p$($,q){return Z$($),null}z(212,l$);z(213,i$);z(214,n$);z(215,O$);z(216,f$);z(217,c$);z(201,p$);class s{static getDefCell($,q,Q){let j=q+Q*4;if(j+4<=$.length){let W=U.Access.readLispPTR($,j),X=W&2147483648?1:0,K=W>>24&127;return{defpointer:W&2147483647,ccodep:X,argtype:K}}return null}static isCCode($){return $.ccodep!==0}static getFunctionHeaderPtr($){return $.defpointer&2147483647}static readFunctionHeader($,q){let Q=U.Address.lispPtrToByte(q);if(Q+16>$.length)return null;let j=U.Access.readDLword($,Q),W=U.Access.readDLword($,Q+2),X=U.Access.readDLword($,Q+4),K=U.Access.readDLword($,Q+6),Y=$[Q+8],B=Y>>7&1,w=Y>>6&1,V=Y>>4&3,H=Y&15,L=$[Q+9]<<16|$[Q+10]<<8|$[Q+11],A=H<<24|L,F=U.Access.readDLword($,Q+12),N=$[Q+14],x=$[Q+15],k=new Int16Array([W])[0],_=new Int16Array([X])[0];return{stkmin:j,na:k,pv:_,startpc:K,nil4:B,byteswapped:w,argtype:V,framename:A,ntsize:F,nlocals:N,fvaroffset:x}}}var K$=1073741824,s$=2147483648,z$=4294967295;function J0($,q,Q){if($.virtualMemory===null)return null;let j;if(q.opcode===13){if(q.operands.length<2)return null;Q=q.operands[0],j=q.operands[1]}else{if(q.operands.length<1)return null;j=q.operands[0]}let W=s.getDefCell($.virtualMemory,$.atomSpaceOffset,j);if(!W)return console.warn(`FN: Definition cell not found for atom index ${j}`),null;if(s.isCCode(W))return console.warn(`FN: C code functions not yet supported for atom index ${j}`),null;let X=s.getFunctionHeaderPtr(W);if(X===0)return console.warn(`FN: Function header pointer is 0 for atom index ${j}`),null;let K=s.readFunctionHeader($.virtualMemory,X);if(!K)return console.warn(`FN: Failed to read function header at 0x${X.toString(16)}`),null;let Y=q.length,B=$.pc-($.funcObj||0)+Y,w=$.stackPtr-Q*4+4,V=(w-$.stackBase)/2;if($.ivar=w,Z($,$.topOfStack),K.na>=0){let x=Q-K.na;if(x<0)for(let k=0;k<-x;k++)Z($,G);else if(x>0){if($.stackPtr-=x*4,$.cstkptrl!==null)$.cstkptrl-=x}}let H=s$|V&65535;Z($,H);let L=($.stackPtr-$.stackBase)/2,A=K$<<16|L&65535;Z($,A);let F=$.stackPtr;if(U.Access.writeLispPTR($.virtualMemory,F,X),$.stackPtr+=W0*2,$.cstkptrl=$.stackPtr,$.pvar=$.stackPtr,K.pv>=0)for(let x=K.pv;x>=0;x--)Z($,z$),Z($,z$);Z($,G);let N=U.Address.lispPtrToByte(X);return $.pc=N+K.startpc+1,$.funcObj=N,$.syncTopOfStack(),null}function d$($,q){return J0($,q,0)}function v$($,q){return J0($,q,1)}function o$($,q){return J0($,q,2)}function r$($,q){return J0($,q,3)}function t$($,q){return J0($,q,4)}function a$($,q){return J0($,q,-1)}function m$($,q){if($.virtualMemory===null||$.cstkptrl===null)return null;let Q=$.topOfStack,j=!1,W=$.cstkptrl;for(let k=0;k<1000;k++){if(W-=4,W<$.stackEnd||W>=$.stackBase)break;if((U.Access.readLispPTR($.virtualMemory,W)&K$)!==0){j=!0;break}}if(!j)return console.warn("RETURN: FX marker not found"),null;let X=W-4,Y=U.Access.readLispPTR($.virtualMemory,X)&65535,B=$.stackBase+Y*2;$.ivar=B;let w=U.Access.readDLword($.virtualMemory,W+4),H=U.Access.readDLword($.virtualMemory,W+6)<<16|w;if(!s.readFunctionHeader($.virtualMemory,H))return console.warn("RETURN: Failed to read function header"),null;let A=U.Access.readDLword($.virtualMemory,W+10),F=U.Address.lispPtrToByte(H);$.pc=F+A,$.funcObj=F;let x=(U.Access.readLispPTR($.virtualMemory,W)&65535)*2;return $.pvar=$.stackBase+x,$.stackPtr=W,$.cstkptrl=W,$.topOfStack=Q,$.syncTopOfStack(),null}z(8,d$);z(9,v$);z(10,o$);z(11,r$);z(12,t$);z(13,a$);z(16,m$);function e$($,q){if(q.operands.length<1)return null;return q.operands[0]}function $6($,q){if(q.operands.length<1)return null;if($.topOfStack===0)return q.operands[0];return null}function J6($,q){if(q.operands.length<1)return null;if($.topOfStack!==0)return q.operands[0];return null}z(176,e$);z(178,$6);z(179,J6);function q6($,q){if($.virtualMemory===null||q.operands.length<1)return null;let Q=D($),j=q.operands[0],W=(Q&2147483647)+j;if(W+2<=$.virtualMemory.length){let X=U.Access.readDLword($.virtualMemory,W);Z($,E|X)}else Z($,0);return null}function Q6($,q){if($.virtualMemory===null||q.operands.length<1)return null;let Q=D($),j=D($),W=q.operands[0],X=(j&2147483647)+W,K=Q&65535;if(X+2<=$.virtualMemory.length)U.Access.writeDLword($.virtualMemory,X,K);return Z($,j),null}function j6($,q){if($.virtualMemory===null||q.operands.length<1)return null;let Q=D($),j=q.operands[0],W=(Q&2147483647)+j;if(W+4<=$.virtualMemory.length){let X=U.Access.readLispPTR($.virtualMemory,W);Z($,X&2147483647)}else Z($,0);return null}function W6($,q){if($.virtualMemory===null||q.operands.length<1)return null;let Q=D($),j=D($),W=q.operands[0],X=(j&2147483647)+W;if(X+4<=$.virtualMemory.length)U.Access.writeLispPTR($.virtualMemory,X,Q&2147483647);return Z($,j),null}z(200,q6);z(205,Q6);z(236,j6);z(206,W6);function U6($,q){return null}function X6($,q){return null}function Z6($,q){return null}function z6($,q){return null}z(232,U6);z(233,X6);z(234,Z6);z(235,z6);function K6($,q){if($.virtualMemory===null)return null;return console.warn("UBFLOAT3: Placeholder - no-op"),null}z(50,K6);function Y6($,q){return null}function G6($,q){return null}function D6($,q){return null}z(196,Y6);z(48,G6);z(59,D6);class Z0{static getValueCell($,q,Q){let j=q+Q*4;if(j+4<=$.length)return U.Access.readLispPTR($,j);return 0}static setValueCell($,q,Q,j){let W=q+Q*4;if(W+4<=$.length)U.Access.writeLispPTR($,W,j)}static getGlobalVarValueCellAddress($,q,Q){return q+Q*4}}class C{static readPVAR($,q){if($.virtualMemory===null||$.pvar===null)return 0;let Q=$.pvar+q*4;if(Q+4<=$.virtualMemory.length)return U.Access.readLispPTR($.virtualMemory,Q);return 0}static writePVAR($,q,Q){if($.virtualMemory===null||$.pvar===null)return;let j=$.pvar+q*4;if(j+4<=$.virtualMemory.length)U.Access.writeLispPTR($.virtualMemory,j,Q)}static readIVAR($,q){if($.virtualMemory===null||$.ivar===null)return 0;let Q=$.ivar+q*4;if(Q+4<=$.virtualMemory.length)return U.Access.readLispPTR($.virtualMemory,Q);return 0}static writeIVAR($,q,Q){if($.virtualMemory===null||$.ivar===null)return;let j=$.ivar+q*4;if(j+4<=$.virtualMemory.length)U.Access.writeLispPTR($.virtualMemory,j,Q)}static readFVAR($,q){if($.virtualMemory===null||$.pvar===null)return 0;let Q=$.pvar+q*2;if(Q+4<=$.virtualMemory.length){if((U.Access.readDLword($.virtualMemory,Q)&32768)!==0)return 0;let W=U.Access.readDLword($.virtualMemory,Q+2),X=U.Access.readDLword($.virtualMemory,Q),Y=((W&65535)<<16|X&65535)&268435455;if(Y!==0){let B=U.Address.lispPtrToByte(Y);if(B+4<=$.virtualMemory.length)return U.Access.readLispPTR($.virtualMemory,B)}}return 0}static readARG0($){if($.ivar!==null)return C.readIVAR($,0);return 0}static getCurrentFX($){if($.pvar===null)return null;return $.pvar-W0*2}static readALink($){let q=C.getCurrentFX($);if(q===null||$.virtualMemory===null)return 0;if(q+4<=$.virtualMemory.length)return U.Access.readDLword($.virtualMemory,q+2);return 0}static readBLink($){let q=C.getCurrentFX($);if(q===null||$.virtualMemory===null)return 0;if(q+18<=$.virtualMemory.length)return U.Access.readDLword($.virtualMemory,q+16);return 0}static getArgCount($){if($.virtualMemory===null||$.pvar===null||$.ivar===null)return 0;let q=C.getCurrentFX($);if(q===null)return 0;let Q=C.readALink($),j;if((Q&1)===0)j=q-4;else{let X=C.readBLink($);j=$.stackBase+X*2}let W=j-$.ivar>>2;return E|W&65535}static getALink($){if(C.getCurrentFX($)===null)return 0;let W=(C.readALink($)&65534)-W0;return E|W&65535}static parseFrame($,q){if($.virtualMemory===null)return null;let Q=U.Address.lispPtrToByte(q);if(Q+20>$.virtualMemory.length)return null;return{flags_usecount:U.Access.readDLword($.virtualMemory,Q),alink:U.Access.readDLword($.virtualMemory,Q+2),lofnheader:U.Access.readDLword($.virtualMemory,Q+4),hi1fnheader_hi2fnheader:U.Access.readDLword($.virtualMemory,Q+6),nextblock:U.Access.readDLword($.virtualMemory,Q+8),pc:U.Access.readDLword($.virtualMemory,Q+10),lonametable:U.Access.readDLword($.virtualMemory,Q+12),hi1nametable_hi2nametable:U.Access.readDLword($.virtualMemory,Q+14),blink:U.Access.readDLword($.virtualMemory,Q+16),clink:U.Access.readDLword($.virtualMemory,Q+18)}}}function H6($,q){if($.virtualMemory===null)return null;let Q=U.Access.readByteXor($.virtualMemory,$.pc+1);if(Q===null)return null;let j=Q,W=Z0.getValueCell($.virtualMemory,$.valSpaceOffset,j);return Z($,W),null}function B6($,q){let Q=C.readARG0($);return Z($,Q),null}function V6($,q,Q){let j=C.readIVAR($,Q);return Z($,j),null}function w6($,q){if($.virtualMemory===null||q.operands.length<1)return null;let Q=q.operands[0],j=C.readIVAR($,Q);return Z($,j),null}function Y$($,q,Q){let j=C.readPVAR($,Q);return Z($,j),null}function L6($,q){if($.virtualMemory===null||q.operands.length<1)return null;let Q=q.operands[0],j=C.readPVAR($,Q);return Z($,j),null}function G$($,q,Q){let j=C.readFVAR($,Q);return Z($,j),null}function F6($,q){if($.virtualMemory===null||q.operands.length<1)return null;let Q=q.operands[0];return G$($,q,Q)}function A6($,q,Q){let j=D($);return C.writePVAR($,Q,j),null}function x6($,q){if($.virtualMemory===null||q.operands.length<1)return null;let Q=q.operands[0],j=D($);return C.writePVAR($,Q,j),null}function N6($,q){if($.virtualMemory===null||q.operands.length<1)return null;let Q=q.operands[0],j=D($);return C.writeIVAR($,Q,j),null}function C6($,q){if($.virtualMemory===null||q.operands.length<1)return null;let Q=D($),j=q.operands[0];if($.pvar===null)return Z($,Q),null;let W=$.pvar+j*2;if(W+4<=$.virtualMemory.length){if((U.Access.readDLword($.virtualMemory,W)&32768)!==0)return console.warn(`FVARX_: Attempting to set unbound FVAR ${j} - name table lookup needed`),Z($,Q),null;let K=U.Access.readDLword($.virtualMemory,W+2),Y=U.Access.readDLword($.virtualMemory,W),w=((K&65535)<<16|Y&65535)&268435455;if(w!==0){let V=U.Address.lispPtrToByte(w);if(V+4<=$.virtualMemory.length)U.Access.writeLispPTR($.virtualMemory,V,Q)}}return Z($,Q),null}function I6($,q,Q){return Y$($,q,Q)}function R6($,q){let Q=C.getArgCount($);return Z($,Q),null}function k6($,q){let Q=C.getALink($);return Z($,Q),null}function b6($,q){if($.virtualMemory===null)return null;if(q.operands.length<1)return null;let Q=D($),j=q.operands[0],W=Z0.getValueCell($.virtualMemory,$.valSpaceOffset,j);return Z0.setValueCell($.virtualMemory,$.valSpaceOffset,j,Q),null}z(96,H6);z(23,b6);z(97,B6);for(let $=0;$<=6;$++)z(64+$,(q,Q)=>V6(q,Q,$));z(71,w6);for(let $=0;$<=6;$++)z(72+$,(q,Q)=>Y$(q,Q,$));z(79,L6);var E6=[0,2,4,6,8,10,12];for(let $=0;$<=6;$++)z(80+$,(q,Q)=>G$(q,Q,E6[$]));z(87,F6);for(let $=0;$<=6;$++)z(184+$,(q,Q)=>A6(q,Q,$));z(95,x6);z(98,N6);z(99,C6);for(let $=0;$<=6;$++)z(88+$,(q,Q)=>I6(q,Q,$));z(101,R6);z(102,k6);function T6($,q){if($.virtualMemory===null||$.ivar===null)return null;let Q=D($),j=U.Access.readByteXor($.virtualMemory,$.pc+1);if(j===null)return Z($,0),null;let W=j,X=W+1,K=$.ivar+W*4-4,B=Math.min(K+400,$.virtualMemory.length-4);for(let w=K;w<B;w+=4,X+=2)if(U.Access.readLispPTR($.virtualMemory,w)===Q){let H=E|X;return Z($,H),null}return Z($,0),null}z(30,T6);var _6=128;var P6=254,D$=65535;var u=4,g=5,M0=Math.floor((b-u)/g);class w0{memory;plistSpaceOffset;dtdOffset;constructor($,q,Q){this.memory=$,this.plistSpaceOffset=q,this.dtdOffset=Q}readConsPage($){if($+u>this.memory.length)return null;let q=this.memory[$],Q=this.memory[$+1],j=U.Access.readDLword(this.memory,$+2);return{count:q,next_cell:Q,next_page:j}}writeConsPage($,q){if($+u>this.memory.length)return;this.memory[$]=q.count,this.memory[$+1]=q.next_cell,U.Access.writeDLword(this.memory,$+2,q.next_page)}readConsCell($){if($+g>this.memory.length)return null;let q=U.Access.readLispPTR(this.memory,$),Q=this.memory[$+4];return{car_field:q,cdr_code:Q}}writeConsCell($,q){if($+g>this.memory.length)return;U.Access.writeLispPTR(this.memory,$,q.car_field),this.memory[$+4]=q.cdr_code}getNextConsPage(){let q=this.dtdOffset+90;if(q+32>this.memory.length)return 0;let Q=U.Access.readDLword(this.memory,q+28),W=U.Access.readDLword(this.memory,q+30)<<16|Q;if(W===0||W===D$)return 0;return U.Address.lispPtrToByte(W)}findFreeConsCell(){let $=this.getNextConsPage();if($===0)return null;while($!==0&&$!==D$){let q=U.Address.lispPtrToByte($),Q=this.readConsPage(q);if(!Q)break;if(Q.count>0){let j=q+u+Q.next_cell*g,W=this.memory[j+4];return Q.count--,Q.next_cell=W,this.writeConsPage(q,Q),j}else $=Q.next_page}return null}allocateNewConsPage(){let $=this.plistSpaceOffset,q={count:M0-1,next_cell:1,next_page:0};this.writeConsPage($,q);for(let j=1;j<M0-1;j++){let W=$+u+j*g;U.Access.writeLispPTR(this.memory,W,G),this.memory[W+4]=j+1}let Q=$+u+(M0-1)*g;return U.Access.writeLispPTR(this.memory,Q,G),this.memory[Q+4]=0,$}allocateConsCell($,q){let Q=null;if(q===G){if(Q=this.findFreeConsCell(),!Q){let W=this.allocateNewConsPage();if(!W)return G;let X=this.readConsPage(W);if(!X)return G;Q=W+u+X.next_cell*g,X.count--;let K=this.memory[Q+4];X.next_cell=K,this.writeConsPage(W,X)}let j={car_field:$,cdr_code:_6};this.writeConsCell(Q,j)}else{console.warn("CONS: Non-NIL CDR not yet fully implemented, using CDR_INDIRECT");let j=this.allocateNewConsPage();if(!j)return G;let W=this.readConsPage(j);if(!W||W.count<2)return G;let X=j+u+W.next_cell*g,K=this.memory[X+4];W.next_cell=K;let Y=j+u+K*g,B=this.memory[Y+4];W.next_cell=B,W.count-=2,this.writeConsPage(j,W),U.Access.writeLispPTR(this.memory,X,q),this.memory[X+4]=0;let w={car_field:$,cdr_code:P6};this.writeConsCell(Y,w);let V=(X-j-u)/g;this.memory[Y+4]=V,Q=Y}return U.Address.byteToLispPtr(Q)}}var h0=128,H$=128,S0=254;function M($,q){if(q===0)return!1;if($.virtualMemory===null)return!1;return U.Address.lispPtrToByte(q)<$.virtualMemory.length}function O($,q){if($.virtualMemory===null)return 0;if(q===0)return 0;let Q=U.Address.lispPtrToByte(q);if(Q+4>$.virtualMemory.length)return 0;return U.Access.readLispPTR($.virtualMemory,Q)}function o($,q){if($.virtualMemory===null)return 0;if(q===0)return 0;let Q=U.Address.lispPtrToByte(q);if(Q+5>$.virtualMemory.length)return 0;let j=$.virtualMemory[Q+4];if(j===h0||j===0)return 0;else if((j&H$)!==0){let W=U.Address.getVirtualAddressBase(U.Address.getVirtualPage(Q)),X=(j&127)<<1;return U.Address.byteToLispPtr(W+X)}else if(j===S0){let W=Q+8;if(W+4>$.virtualMemory.length)return 0;return U.Access.readLispPTR($.virtualMemory,W)}else{let W=U.Address.getVirtualAddressBase(U.Address.getVirtualPage(Q)),X=j<<1;return U.Address.byteToLispPtr(W+X)}}function M6($,q){let Q=D($),j=O($,Q);return Z($,j),null}function h6($,q){let Q=D($),j=o($,Q);return Z($,j),null}function S6($,q){if($.virtualMemory===null)return null;let Q=D($),j=D($),X=new w0($.virtualMemory,$.plistSpaceOffset,$.dtdOffset).allocateConsCell(j,Q);if(X===G)return console.warn("CONS: Failed to allocate cons cell"),Z($,G),null;return Z($,X),null}function y6($,q){if($.virtualMemory===null)return null;let Q=D($),j=D($);if(j===0){if(Q!==0)return console.warn("RPLACA: Attempt to RPLACA NIL"),Z($,0),null;return Z($,0),null}if(!M($,j))return console.warn("RPLACA: ARG not List"),Z($,j),null;let W=U.Address.lispPtrToByte(j);if(W+5>$.virtualMemory.length)return Z($,j),null;if($.virtualMemory[W+4]===S0){let K=U.Access.readLispPTR($.virtualMemory,W),Y=U.Address.lispPtrToByte(K);if(Y+4<=$.virtualMemory.length)U.Access.writeLispPTR($.virtualMemory,Y,Q)}else U.Access.writeLispPTR($.virtualMemory,W,Q);return Z($,j),null}function u6($,q){if($.virtualMemory===null)return null;let Q=D($),j=D($);if(j===0){if(Q!==0)return console.warn("RPLACD: Attempt to RPLACD NIL"),Z($,0),null;return Z($,0),null}if(!M($,j))return console.warn("RPLACD: ARG not List"),Z($,j),null;let W=U.Address.lispPtrToByte(j);if(W+5>$.virtualMemory.length)return Z($,j),null;let X=$.virtualMemory[W+4];if(Q===0)$.virtualMemory[W+4]=h0;else console.warn("RPLACD: Non-NIL CDR coding not fully implemented, using CDR_INDIRECT"),$.virtualMemory[W+4]=h0;return Z($,j),null}function g6($,q){if($.virtualMemory===null)return null;let Q=D($),j=D($);if(!M($,j))return console.warn("RPLCONS: ARG not List"),Z($,G),null;let X=new w0($.virtualMemory,$.plistSpaceOffset,$.dtdOffset).allocateConsCell(Q,G);if(X===G)return console.warn("RPLCONS: Failed to allocate cons cell"),Z($,G),null;let K=U.Address.lispPtrToByte(X),Y=U.Address.lispPtrToByte(j),B=$.virtualMemory[Y+4],w=Math.floor(Y/512),V=Math.floor(K/512);if(w===V){let H=K%512>>1;$.virtualMemory[Y+4]=H$|H&127}else $.virtualMemory[Y+4]=S0,U.Access.writeLispPTR($.virtualMemory,Y,X);return Z($,X),null}function l6($,q){if($.virtualMemory===null)return null;let Q=D($),j=D($);if(j===G)return Z($,G),null;if(!M($,j))return Z($,G),null;while(M($,j)){let W=O($,j);if(M($,W)){let X=O($,W);if(Q===X)return Z($,W),null}if(j=o($,j),j===G)break}return Z($,G),null}function i6($,q){if($.virtualMemory===null)return null;if(q.operands.length<1)return null;let Q=D($);if(q.operands[0]===0)return Z($,Q),null;return Z($,Q),null}function n6($,q){if($.virtualMemory===null)return null;let Q=D($),j=D($);while(M($,j)){let W=O($,j);if(Q===W)return Z($,j),null;j=o($,j)}if(j!==G)return console.warn("FMEMB: ARG not List"),Z($,G),null;return Z($,G),null}function O6($,q){if($.virtualMemory===null)return null;let Q=D($),j=D($);while(j!==G){if(!M($,j))return Z($,G),null;let W=O($,j),X=o($,j);if(W===Q){if(X===G)return Z($,G),null;if(M($,X)){let K=O($,X);return Z($,K),null}else return Z($,G),null}if(!M($,X))return Z($,G),null;j=o($,X)}return Z($,G),null}function f6($,q){if($.virtualMemory===null)return null;let Q=D($),j=D($);if(j===G)return Z($,G),null;if(!M($,j))return Z($,G),null;while(M($,j)){let W=O($,j);if(M($,W)){let X=O($,W);if(Q===X)return Z($,W),null}if(j=o($,j),j===G)break}return Z($,G),null}function c6($,q){if($.virtualMemory===null)return null;let Q=D($),j=D($);while(M($,j)){let W=O($,j);if(Q===W)return Z($,j),null;j=o($,j)}if(j!==G)return console.warn("CMLMEMBER: ARG not List"),Z($,G),null;return Z($,G),null}z(1,M6);z(2,h6);z(26,S6);z(24,y6);z(25,u6);z(38,g6);z(22,l6);z(27,f6);z(35,i6);z(28,n6);z(29,c6);z(39,O6);function p6($,q){let Q=$.topOfStack;return Z($,Q),null}z(100,p6);function s6($,q){if($.virtualMemory===null)return null;if(q.operands.length<2)return null;let Q=q.operands[0],j=q.operands[1],W=Q>>4&15,X=Q&15,B=$.stackPtr+20+(1+j)*4;for(let H=0;H<W;H++){let L=B-(H+1)*4;if(L>=0&&L+4<=$.virtualMemory.length)U.Access.writeLispPTR($.virtualMemory,L,G)}if(X===0)Z($,$.topOfStack);else{let H=B-(W+1)*4;if(H>=0&&H+4<=$.virtualMemory.length)U.Access.writeLispPTR($.virtualMemory,H,$.topOfStack);for(let L=1;L<X;L++){let A=D($),F=B-(W+L+1)*4;if(F>=0&&F+4<=$.virtualMemory.length)U.Access.writeLispPTR($.virtualMemory,F,A)}}let V=(~(W+X)&65535)<<16|j<<1&65535;return Z($,V),null}function d6($,q){if($.virtualMemory===null||$.cstkptrl===null)return null;let Q=!1,j=0,W=$.cstkptrl;for(let V=0;V<1000;V++){if(W-=4,W<$.stackEnd||W>=$.stackBase)break;let H=U.Access.readLispPTR($.virtualMemory,W);if((H&2147483648)!==0){Q=!0,j=H,$.cstkptrl=W;break}}if(!Q)return console.warn("UNBIND: Marker not found"),null;let X=~(j>>16)&65535,K=(j&65535)>>1,B=$.stackPtr+20+(2+K)*4,w=4294967295;for(let V=0;V<X;V++){let H=B-(V+1)*4;if(H>=0&&H+4<=$.virtualMemory.length)U.Access.writeLispPTR($.virtualMemory,H,w)}return $.syncTopOfStack(),null}function v6($,q){return console.warn(`DUNBIND (0x${19 .toString(16)}) not implemented.`),null}z(17,s6);z(18,d6);z(19,v6);var y0=1,F0=2,A0=3,L0=5;function z0($){return($&3221225472)!==0&&($&X0)===$}function f($,q=null){if($===G)return L0;if(($&E)===E)return y0;if(($&R0)===R0)return y0;return L0}function x0($,q=null){let Q=f($,q);return Q===y0||Q===F0||Q===A0}function K0($,q){if(!q.virtualMemory)return null;let Q=U.Address.lispPtrToByte($);if(Q+4>q.virtualMemory.length)return null;return new DataView(q.virtualMemory.buffer,q.virtualMemory.byteOffset+Q).getInt32(0,!0)}function Y0($,q){if(!q.virtualMemory)return null;let Q=U.Address.lispPtrToByte($);if(Q+8>q.virtualMemory.length)return null;return new DataView(q.virtualMemory.buffer,q.virtualMemory.byteOffset+Q).getFloat64(0,!0)}function o6($,q){let Q=D($),j=D($);return Z($,j===Q?v:G),null}function r6($,q){let Q=D($),j=D($);if(j===Q)return Z($,v),null;if(z0(j)||z0(Q)){if(h(j)&&h(Q)){let K=S(j),Y=S(Q);return Z($,K===Y?v:G),null}return Z($,G),null}let W=f(j,$),X=f(Q,$);if(W!==X)return Z($,G),null;switch(W){case F0:{let K=K0(j,$),Y=K0(Q,$);if(K!==null&&Y!==null&&K===Y)return Z($,v),null;return Z($,G),null}case A0:{let K=Y0(j,$),Y=Y0(Q,$);if(K!==null&&Y!==null&&K===Y)return Z($,v),null;return Z($,G),null}default:if(x0(j,$))return Z($,G),null;return Z($,G),null}}function u0($,q,Q,j=0){if(j>100)return!1;if(q===Q)return!0;if(z0(q)||z0(Q)){if(h(q)&&h(Q))return S(q)===S(Q);return!1}let W=f(q,$),X=f(Q,$);if(W!==X){if(x0(q,$)&&x0(Q,$))return!1;return!1}switch(W){case F0:{let K=K0(q,$),Y=K0(Q,$);return K!==null&&Y!==null&&K===Y}case A0:{let K=Y0(q,$),Y=Y0(Q,$);return K!==null&&Y!==null&&K===Y}case L0:{let K=g0($,q),Y=g0($,Q);if(!u0($,K,Y,j+1))return!1;let B=l0($,q),w=l0($,Q);return u0($,B,w,j+1)}default:return!1}}function t6($,q){let Q=D($),j=D($),W=u0($,j,Q);return Z($,W?v:G),null}function a6($,q){return null}function g0($,q){if($.virtualMemory===null)return 0;if(q===0)return 0;let Q=U.Address.lispPtrToByte(q);if(Q+4>$.virtualMemory.length)return 0;return U.Access.readLispPTR($.virtualMemory,Q)}function l0($,q){if($.virtualMemory===null)return 0;if(q===0)return 0;let Q=U.Address.lispPtrToByte(q);if(Q+5>$.virtualMemory.length)return 0;let j=$.virtualMemory[Q+4],W=128,X=128,K=254;if(j===W||j===0)return 0;else if((j&X)!==0){let Y=U.Address.getVirtualAddressBase(U.Address.getVirtualPage(Q)),B=(j&127)<<1;return U.Address.byteToLispPtr(Y+B)}else if(j===K){let Y=Q+8;if(Y+4>$.virtualMemory.length)return 0;return U.Access.readLispPTR($.virtualMemory,Y)}else{let Y=U.Address.getVirtualAddressBase(U.Address.getVirtualPage(Q)),B=j<<1;return U.Address.byteToLispPtr(Y+B)}}function m6($,q){let Q=D($),j=D($),W;if((Q&3758096384)===3758096384)W=Q&65535;else W=0;for(let K=0;K<W;K++){if(j===G)return Z($,G),null;j=l0($,j)}if(j===G)return Z($,G),null;let X=g0($,j);return Z($,X),null}z(240,o6);z(58,r6);z(204,t6);z(122,a6);z(41,m6);function e6($,q){if($.virtualMemory===null)return null;if(q.operands.length<1)return null;let Q=D($),j=D($),W=q.operands[0];if(j===0||(j&~X0)!==0)return Z($,j),null;let X=j+W&X0,K=U.Address.lispPtrToByte(X);if(K<0||K+4>$.virtualMemory.length)return Z($,j),null;return U.Access.writeLispPTR($.virtualMemory,K,Q),Z($,j),null}function $7($,q){if($.virtualMemory===null)return null;if(q.operands.length<1)return null;let Q=q.operands[0];return null}z(20,e6);z(21,$7);function J7($,q){if($.virtualMemory===null)return null;if(q.operands.length<1)return null;let Q=$.topOfStack;return null}function q7($,q){if($.virtualMemory===null)return null;return null}function Q7($,q){if($.virtualMemory===null)return null;let Q=D($);if((Q&v0)!==E)return console.warn("CREATECELL: Type must be S_POSITIVE tagged"),Z($,G),null;let j=Q&65535;return console.warn(`CREATECELL: Placeholder implementation for type ${j}`),Z($,G),null}z(36,J7);z(123,q7);z(31,Q7);function j7($,q){if($.virtualMemory===null)return null;return D($),console.warn("BIN: Placeholder - returning 0"),Z($,E|0),null}function W7($,q){if($.virtualMemory===null)return null;return console.warn("EVAL: Placeholder - returning expression"),null}function U7($,q){if($.virtualMemory===null)return null;return D($),console.warn("ENVCALL: Placeholder - returning NIL"),Z($,G),null}function X7($,q){if($.virtualMemory===null)return null;return D($),D($),console.warn("TYPECHECK: Placeholder - returning T"),Z($,1),null}z(32,j7);z(44,W7);z(45,U7);z(46,X7);function Z7($,q){if($.virtualMemory===null)return null;return console.warn("STKSCAN: Placeholder - no-op"),null}function z7($,q){if($.virtualMemory===null)return null;return console.warn("MISC8: Placeholder - no-op"),null}z(47,Z7);z(49,z7);function K7($,q){if($.virtualMemory===null)return null;let Q=$.topOfStack,j=f(Q,$);return $.topOfStack=j,null}function Y7($,q){if($.virtualMemory===null)return null;if(q.operands.length<1)return null;let Q=q.operands[0],j=$.topOfStack;if(f(j,$)!==Q)$.topOfStack=G;return null}function G7($,q){if($.virtualMemory===null)return null;if(q.operands.length<2)return null;let Q=q.operands[0]|q.operands[1]<<8;return $.topOfStack=G,null}function D7($,q){if($.virtualMemory===null)return null;return null}z(4,K7);z(5,Y7);z(6,G7);z(7,D7);function H7($,q){return B7($,q)}function B7($,q){let Q=j$($,q);if(Q===null){let j=q.opcode;if(j>=128&&j<=143)return j-128+1;if(j>=144&&j<=159){if($.topOfStack===0)return j-144+1;return null}if(j>=160&&j<=175){if($.topOfStack!==0)return j-160+1;return null}}return Q}function i0($,q){if($.virtualMemory===null)return!1;if($.maxSteps!==null&&$.totalInstructionCount>=$.maxSteps)return $.stopRequested=!0,!1;if($.stopRequested)return!1;$.initCSTKPTRLFromCurrentStackPTR(),$.syncTopOfStack();let Q=q$($,$.pc);if(Q===null)return $.stopRequested=!0,!1;if(q)q.logInstruction($,Q,!1);let j=H7($,Q);if(j!==null){let W=$.pc+j;if(W<0||W>=$.virtualMemory.length)return $.stopRequested=!0,!1;if($.pc=W,j===0)$.pc+=Q.length}else $.pc+=Q.length;return $.totalInstructionCount++,!0}function V7($,q){let Q=new DataView($,q),j={resetfxp:Q.getUint16(0,!1),currentfxp:Q.getUint16(2,!1),kbdfxp:Q.getUint16(4,!1),subovfxp:Q.getUint16(6,!1),gcfxp:Q.getUint16(8,!1),hardreturnfxp:Q.getUint16(10,!1),endofstack:Q.getUint16(12,!1),faultfxp:Q.getUint16(14,!1),minrversion:Q.getUint16(16,!1),lversion:Q.getUint16(18,!1),rversion:Q.getUint16(20,!1),minbversion:Q.getUint16(22,!1),machinetype:Q.getUint16(24,!1),bversion:Q.getUint16(26,!1),key:Q.getUint16(30,!1),miscfxp:Q.getUint16(28,!1),emulatorspace:Q.getUint16(32,!1),serialnumber:Q.getUint16(34,!1),nxtpmaddr:Q.getUint16(36,!1),screenwidth:Q.getUint16(38,!1),ndirtypages:Q.getUint16(40,!1),nactivepages:Q.getUint16(42,!1),filepnpmt0:Q.getUint16(44,!1),filepnpmp0:Q.getUint16(46,!1),filler1:Q.getUint16(48,!1),teleraidfxp:Q.getUint16(50,!1),filler3:Q.getUint16(52,!1),filler2:Q.getUint16(54,!1),userpswdaddr:Q.getUint16(56,!1),usernameaddr:Q.getUint16(58,!1),faulthi:Q.getUint16(60,!1),stackbase:Q.getUint16(62,!1),devconfig:Q.getUint16(64,!1),faultlo:Q.getUint16(66,!1),rpoffset:Q.getUint16(68,!1),rptsize:Q.getUint16(70,!1),embufvp:Q.getUint16(72,!1),wasrptlast:Q.getUint16(74,!1),nshost1:Q.getUint16(76,!1),nshost0:Q.getUint16(78,!1),mdszone:Q.getUint16(80,!1),nshost2:Q.getUint16(82,!1),emubuffers:Q.getUint16(84,!1),mdszonelength:Q.getUint16(86,!1),process_size:Q.getUint16(88,!1),emubuflength:Q.getUint16(90,!1),isfmap:Q.getUint16(92,!1),storagefullstate:Q.getUint16(94,!1),miscstackfn:Q.getUint32(96,!1),miscstackarg1:Q.getUint32(100,!1),miscstackarg2:Q.getUint32(104,!1),miscstackresult:Q.getUint32(108,!1),lastlockedfilepage:Q.getUint16(112,!1),nrealpages:Q.getUint16(114,!1),fptovpstart:Q.getUint16(116,!1),lastdominofilepage:Q.getUint16(118,!1),dl24bitaddressable:Q.getUint16(120,!1),fakemousebits:Q.getUint16(122,!1),realpagetableptr:Q.getUint32(124,!1),fullspaceused:Q.getUint16(128,!1),dllastvmempage:Q.getUint16(130,!1),fakekbdad5:Q.getUint16(132,!1),fakekbdad4:Q.getUint16(134,!1)};if(j.key!==C0)throw Error(`Invalid IFPAGE key: expected 0x${C0.toString(16)}, got 0x${j.key.toString(16)}`);return j}function w7($,q,Q){let j=Math.floor(Q/b*2),X=(q.fptovpstart-1)*b+4,K=j*2+4,Y=$.byteLength-X,B=Math.min(K,Y);if(B<4)throw Error(`FPtoVP table too small: offset=${X}, available=${Y}`);let w=$.slice(X,X+B),V=Math.floor(B/4),H=new Uint32Array(V),L=new DataView($,X,B);for(let A=0;A<V;A++){let F=L.getUint32(A*4,!1);H[A]=U.Endianness.swapU32(F)}return H}function L7($,q,Q){let j=Q.process_size;if(j===0)j=64;let W=j*1024*1024,X=new Uint8Array(W),K=Math.floor($.byteLength/b*2),Y=new Uint8Array($),B=0,w=Math.floor(K/2);for(let V=0;V<w;V++){if(V>=q.length)break;let H=q[V];if((H>>16&65535)===65535||H===0)continue;let A=H&65535;if(A===0)continue;let F=V*b,N=A*b;if(F+b>$.byteLength){console.error(`Page ${V}: File offset ${F} exceeds file size ${$.byteLength}`);continue}if(N+b>X.length){console.error(`Page ${V}: Virtual offset ${N} exceeds VM size ${X.length}`);continue}let x=Y.slice(F,F+b);X.set(x,N);let k=new DataView(X.buffer,X.byteOffset+N,b);for(let _=0;_<b;_+=4){let c=k.getUint32(_,!1);k.setUint32(_,U.Endianness.swapU32(c),!0)}B++}return console.error(`Loaded ${B} pages into virtual memory (${j}MB)`),X}function F7($,q){let Q=n*2,j=q.currentfxp,W=Q+j*2;if(j===0||W+20>$.length)return 0;if($.slice(W,W+20).every((N)=>N===0))return 0;let K=new DataView($.buffer,$.byteOffset+W),Y=K.getUint16(4,!1),w=$[W+7]<<16|Y;if(w===0)return 0;let V=K.getUint16(10,!1),H=U.Address.lispPtrToByte(w);if(H+8>$.length)return 0;let A=new DataView($.buffer,$.byteOffset+H).getUint16(6,!1);return H+A+V}async function B$($){let q=V7($,s0);if(q===null)throw Error("Failed to parse IFPAGE");let Q=w7($,q,$.byteLength),j=L7($,Q,q),W=F7(j,q),X=n*2,K=U.Address.lispPtrToByte(o0),Y=U.Address.lispPtrToByte(r0),B=U.Address.lispPtrToByte(t0),w=U.Address.lispPtrToByte(a0),V=U.Address.lispPtrToByte(m0);return{virtualMemory:j,fptovpTable:Q,ifpage:q,initialPC:W,initialSP:X,atomSpaceOffset:K,defSpaceOffset:Y,valSpaceOffset:B,plistSpaceOffset:w,dtdOffset:V}}class n0{gl=null;canvas;program=null;texture=null;displayWidth=0;displayHeight=0;constructor($){this.canvas=$,this.initWebGL()}initWebGL(){let $=this.canvas.getContext("webgl2");if(!$)throw Error("WebGL 2.0 not supported");this.gl=$,this.program=this.createShaderProgram(),this.texture=$.createTexture(),$.bindTexture($.TEXTURE_2D,this.texture),$.texParameteri($.TEXTURE_2D,$.TEXTURE_MIN_FILTER,$.NEAREST),$.texParameteri($.TEXTURE_2D,$.TEXTURE_MAG_FILTER,$.NEAREST),$.texParameteri($.TEXTURE_2D,$.TEXTURE_WRAP_S,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_2D,$.TEXTURE_WRAP_T,$.CLAMP_TO_EDGE)}createShaderProgram(){if(!this.gl)throw Error("WebGL not initialized");let $=`#version 300 es
            in vec2 a_position;
            in vec2 a_texCoord;
            out vec2 v_texCoord;
            void main() {
                gl_Position = vec4(a_position, 0.0, 1.0);
                v_texCoord = a_texCoord;
            }
        `,q=`#version 300 es
            precision highp float;
            uniform sampler2D u_texture;
            uniform vec2 u_resolution;
            in vec2 v_texCoord;
            out vec4 fragColor;
            void main() {
                vec2 coord = v_texCoord;
                vec4 color = texture(u_texture, coord);
                fragColor = color;
            }
        `,Q=this.compileShader(this.gl.VERTEX_SHADER,$),j=this.compileShader(this.gl.FRAGMENT_SHADER,q),W=this.gl.createProgram();if(!W)throw Error("Failed to create program");if(this.gl.attachShader(W,Q),this.gl.attachShader(W,j),this.gl.linkProgram(W),!this.gl.getProgramParameter(W,this.gl.LINK_STATUS)){let X=this.gl.getProgramInfoLog(W);throw Error(`Program link failed: ${X}`)}return W}compileShader($,q){if(!this.gl)throw Error("WebGL not initialized");let Q=this.gl.createShader($);if(!Q)throw Error("Failed to create shader");if(this.gl.shaderSource(Q,q),this.gl.compileShader(Q),!this.gl.getShaderParameter(Q,this.gl.COMPILE_STATUS)){let j=this.gl.getShaderInfoLog(Q);throw this.gl.deleteShader(Q),Error(`Shader compilation failed: ${j}`)}return Q}updateDisplay($,q,Q){if(!this.gl||!this.texture||!this.program)return;this.displayWidth=q,this.displayHeight=Q;let j=new Uint8Array(q*Q*4);for(let W=0;W<$.length;W++){let X=$[W],K=Math.floor(W/q),Y=W%q,B=(K*q+Y)*4,w=X&1;j[B]=w?255:0,j[B+1]=w?255:0,j[B+2]=w?255:0,j[B+3]=255}this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,q,Q,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,j)}render(){if(!this.gl||!this.program||!this.texture)return;this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT);let $=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),q=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,q),this.gl.bufferData(this.gl.ARRAY_BUFFER,$,this.gl.STATIC_DRAW);let Q=this.gl.getAttribLocation(this.program,"a_position"),j=this.gl.getAttribLocation(this.program,"a_texCoord");if(Q>=0)this.gl.enableVertexAttribArray(Q),this.gl.vertexAttribPointer(Q,2,this.gl.FLOAT,!1,16,0);if(j>=0)this.gl.enableVertexAttribArray(j),this.gl.vertexAttribPointer(j,2,this.gl.FLOAT,!1,16,8);let W=this.gl.getUniformLocation(this.program,"u_resolution");if(W)this.gl.uniform2f(W,this.canvas.width,this.canvas.height);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}class O0{lines=[];lineNumber=0;logInstruction($,q,Q=!1){let j=this.formatTraceLine($,q,Q);this.lines.push(j),this.lineNumber++}formatTraceLine($,q,Q){let j=[];j.push(this.lineNumber.toString()),j.push(`0x${$.pc.toString(16)}`),j.push(I[q.opcode]||`0x${q.opcode.toString(16)}`),j.push(`0x${q.opcode.toString(16)}`);let W=Array.from(q.operands).map((K)=>`0x${K.toString(16).padStart(2,"0")}`).join(",");j.push(W||"-");let X=`PC=0x${$.pc.toString(16)} SP=0x${$.getStackPtrOffset().toString(16)} FP=0x${$.getFramePtrOffset().toString(16)} TOS=0x${$.topOfStack.toString(16)}`;return j.push(X),j.push("-"),j.push(`SP=0x${$.getStackPtrOffset().toString(16)} FP=0x${$.getFramePtrOffset().toString(16)}`),j.push(`TOS=0x${$.topOfStack.toString(16)}`),j.push("-"),j.push("-"),j.push("-"),j.push("-"),j.join("|")}export(){return this.lines.join(`
`)}clear(){this.lines=[],this.lineNumber=0}}function V$($,q){if($.virtualMemory===null)return!1;$.topOfStack=G;let Q=n*2,j=q.currentfxp,W=Q+j*2,X=W+$0;if(W+$0>$.virtualMemory.length)return console.error(`initializeVM: Frame offset ${W} out of bounds`),!1;$.pvar=X;let K=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+W),Y=Array.from($.virtualMemory.slice(W,W+$0)).map((P)=>`0x${P.toString(16).padStart(2,"0")}`).join(" ");console.error(`initializeVM: Frame bytes: ${Y}`);let B=K.getUint16(0,!1),w=K.getUint16(2,!1),V=K.getUint16(4,!1),H=$.virtualMemory[W+7],L=K.getUint16(8,!1),A=K.getUint16(10,!1);if(console.error(`initializeVM: flags_usecount=0x${B.toString(16)}, alink=0x${w.toString(16)}, lofnheader=0x${V.toString(16)}, hi2fnheader=0x${H.toString(16)}, nextblock=0x${L.toString(16)}, pc=0x${A.toString(16)}`),L===0){if(console.error("initializeVM: nextblock is 0 - initializing sparse stack area..."),!A7($,W,j))return!1;if(B=K.getUint16(0,!1),w=K.getUint16(2,!1),V=K.getUint16(4,!1),H=$.virtualMemory[W+7],L=K.getUint16(8,!1),A=K.getUint16(10,!1),L===0)return console.error("initializeVM: nextblock still 0 after initialization"),!1;console.error(`initializeVM: Stack initialized, nextblock=0x${L.toString(16)}`)}let F=Q+L*2;if(console.error(`initializeVM: nextblock=${L} (0x${L.toString(16)}), nextblockByteOffset=0x${F.toString(16)}`),F+4>$.virtualMemory.length)return console.error(`initializeVM: nextblock offset ${F} out of bounds`),!1;console.error(`initializeVM: Reading FSB at offset 0x${F.toString(16)}`);let N=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+F),x=Array.from($.virtualMemory.slice(F,F+4)).map((P)=>`0x${P.toString(16).padStart(2,"0")}`).join(" ");console.error(`initializeVM: Raw FSB bytes: ${x}`);let k=N.getUint32(0,!0),_=k>>16&65535,c=k&65535;if(console.error(`initializeVM: Read FSB: fsbValue=0x${k.toString(16)}, flagword=0x${_.toString(16)}, size=${c}`),_!==U0)return console.error(`initializeVM: Next stack block isn't free: flagword=0x${_.toString(16)}, expected STK_FSB_WORD=0x${U0.toString(16)}`),!1;let y=F,Q0=y;while(y+4<=$.virtualMemory.length){let i=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+y).getUint32(0,!0);if((i>>16&65535)!==U0)break;let j0=i&65535;Q0=y,y=y+j0*2}$.stackEnd=Q0,$.stackPtr=F-2,$.cstkptrl=$.stackPtr;let t=W-4;if(t>=0&&t+2<=$.virtualMemory.length){let i=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+t).getUint16(0,!1);$.ivar=Q+i*2}else $.ivar=null;let G0=H<<16|V;if(G0===0){console.error("initializeVM: fnheaderPtr is 0 - attempting to locate entry point...");let P=x7($,q);if(P===null)return console.error("initializeVM: Could not locate entry point function"),$.funcObj=null,$.pc=0,!0;let i=U.Address.byteToLispPtr(P.fnheaderOffset),m=i&65535,j0=i>>16&255;K.setUint16(4,m,!1),$.virtualMemory[W+7]=j0,K.setUint16(10,P.pcOffset,!1);let H0=K.getUint16(4,!1),p=$.virtualMemory[W+7];G0=p<<16|H0,V=H0,H=p,A=P.pcOffset,console.error(`initializeVM: Found entry point: fnheader=0x${P.fnheaderOffset.toString(16)}, pcOffset=${P.pcOffset}`)}let d=U.Address.lispPtrToByte(G0);$.funcObj=d;let l=K.getUint16(10,!1);if(d+8>$.virtualMemory.length)return console.error(`initializeVM: Function header offset ${d} out of bounds`),!1;let a=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+d).getUint16(4,!0);return $.pc=d+a*2+l*2,console.error(`initializeVM: PC calculation: fnheader=0x${d.toString(16)}, startpc=${a}, framePc=${l}, finalPC=0x${$.pc.toString(16)}`),!0}function A7($,q,Q){if($.virtualMemory===null)return!1;let j=n*2,X=q+$0;if(X+4>$.virtualMemory.length)return console.error("initializeSparseStack: Not enough space for free block"),!1;let Y=X-1024,B=Math.max(Y-(j-65536),I0*2),w=Math.floor(B/2);if(w<I0)return console.error(`initializeSparseStack: Free block too small: ${w} DLwords`),!1;let V=q-4;if(V>=0){let _=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+V),c=Math.floor((X-j)/2);_.setUint16(0,c,!1),_.setUint16(2,d0,!1)}let H=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+q);H.setUint16(0,0,!1),H.setUint16(2,0,!1),H.setUint16(4,0,!1),$.virtualMemory[q+6]=0,$.virtualMemory[q+7]=0;let L=Math.floor((X-j)/2);H.setUint16(8,L,!1),H.setUint16(10,0,!1),H.setUint16(12,0,!1),$.virtualMemory[q+14]=0,$.virtualMemory[q+15]=0,H.setUint16(16,0,!1),H.setUint16(18,0,!1);let A=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+X),F=U0<<16|w;A.setUint32(0,F,!0);let N=A.getUint32(0,!0),x=N>>16&65535,k=N&65535;return console.error(`initializeSparseStack: Wrote FSB: flagword=0x${x.toString(16)}, size=${k} DLwords`),console.error(`initializeSparseStack: Created frame at 0x${q.toString(16)}, free block at 0x${X.toString(16)} (size=${w} DLwords)`),!0}function x7($,q){if($.virtualMemory===null)return null;let Q=n*2,j=q.resetfxp;if(j!==0){let Y=Q+j*2;if(Y+$0<=$.virtualMemory.length){let B=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+Y),w=B.getUint16(4,!0),H=$.virtualMemory[Y+7]<<16|w;if(H!==0){let L=U.Address.lispPtrToByte(H);if(L+8<=$.virtualMemory.length){let F=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+L).getUint16(4,!0),N=B.getUint16(10,!0);return console.error(`locateEntryPoint: Found function header in resetfxp frame: 0x${L.toString(16)}, startpc=${F}, framePc=${N}`),{fnheaderOffset:L,pcOffset:N}}}}}let W=$.atomSpaceOffset,X=Math.min($.virtualMemory.length,W+20971520),K=[];for(let Y=W;Y<X-8;Y+=512){let B=Math.min(Y+512,X);if($.virtualMemory.slice(Y,B).every((V)=>V===0))continue;for(let V=Y;V<B-8;V+=2){let H=new DataView($.virtualMemory.buffer,$.virtualMemory.byteOffset+V),L=H.getInt16(0,!0),A=H.getUint16(2,!0),F=H.getUint16(4,!0),N=H.getInt16(6,!0);if(L>=-1&&L<=20&&A>=0&&A<=1000&&F>0&&F<=500&&N>=-1&&N<=20){let x=V+F*2;if(x<$.virtualMemory.length&&x>V){let k=$.virtualMemory.slice(x,x+10);if(!k.every((c)=>c===0)){let y=k[0]^3;if(y>0&&y<200&&y!==255){let Q0=Math.floor(x/512)*512,t=Q0+512;if(t<=$.virtualMemory.length){if(!$.virtualMemory.slice(Q0,t).every((l)=>l===0)){let l=Math.floor(x/512)*512,D0=x^3,a=Math.floor(D0/512)*512;if(l+512<=$.virtualMemory.length){if($.virtualMemory.slice(l,l+512).every((e)=>e===0))continue}else continue;if(a+512<=$.virtualMemory.length){if($.virtualMemory.slice(a,a+512).every((e)=>e===0))continue}else continue;if(x>=$.virtualMemory.length||D0>=$.virtualMemory.length)continue;let P=$.virtualMemory[x],i=$.virtualMemory[D0];if(P===0||i===0)continue;let m=0,j0=20,H0=l;for(let p=0;p<j0;p++){let B0=H0+p*512,e=B0+512;if(e>$.virtualMemory.length)break;if($.virtualMemory.slice(B0,e).every((b$)=>b$===0))break;m++}if(m>=3)K.push({fnheaderOffset:V,pcOffset:0,consecutivePages:m,startpc:F})}}}}}}}}if(K.length>0){K.sort((B,w)=>{if(B.consecutivePages!==w.consecutivePages)return w.consecutivePages-B.consecutivePages;return B.startpc-w.startpc});let Y=K[0];return console.error(`locateEntryPoint: Found ${K.length} candidate(s), selected best: fnheader=0x${Y.fnheaderOffset.toString(16)}, startpc=${Y.startpc}, ${Y.consecutivePages} consecutive loaded pages`),{fnheaderOffset:Y.fnheaderOffset,pcOffset:Y.pcOffset}}return console.error("locateEntryPoint: Could not find entry point function"),null}class f0{vm;canvas;options;traceEnabled=!1;traceBuffer=[];renderer=null;tracer=null;animationFrameId=null;constructor($,q={}){this.canvas=$,this.options=q,this.vm=new E0,this.traceEnabled=q.enableTracing??!1;try{this.renderer=new n0($)}catch(Q){console.error("Failed to initialize WebGL:",Q)}if(this.traceEnabled)this.tracer=new O0;if(q.maxSteps!==void 0)this.vm.maxSteps=q.maxSteps,this.vm.stepCapActive=!0}async loadSysout($){let q=await B$($);this.vm.initializeMemory(q.virtualMemory,q.fptovpTable,q.atomSpaceOffset,q.defSpaceOffset,q.valSpaceOffset,q.plistSpaceOffset,q.dtdOffset),console.error("Calling initializeVM...");let Q=V$(this.vm,q.ifpage);if(console.error(`initializeVM result: ${Q}`),!Q)this.vm.pc=q.initialPC,this.vm.stackPtr=q.initialSP,this.vm.cstkptrl=q.initialSP,console.error("VM initialization failed (sparse stack?), using fallback values");else console.error(`VM initialized successfully: PC=0x${this.vm.pc.toString(16)}, SP=0x${this.vm.stackPtr.toString(16)}`);let j=q.ifpage.screenwidth||1024,W=768,X=2097152;this.vm.initializeDisplay(X,j,W)}start(){if(this.vm.virtualMemory===null)throw Error("Sysout not loaded");this.runExecutionLoop()}runExecutionLoop(){let $=()=>{if(this.vm.stopRequested||!this.vm.running){this.animationFrameId=null;return}let q=1000;for(let Q=0;Q<q&&!this.vm.stopRequested;Q++)if(!i0(this.vm))break;this.updateDisplay(),this.animationFrameId=requestAnimationFrame($)};this.vm.running=!0,this.vm.stopRequested=!1,this.animationFrameId=requestAnimationFrame($)}updateDisplay(){if(!this.renderer||!this.vm.displayRegion)return;let $=this.vm.displayRegion,q=this.vm.displayWidth,Q=this.vm.displayHeight;if(q>0&&Q>0)this.renderer.updateDisplay($,q,Q),this.renderer.render()}stop(){if(this.vm.stopRequested=!0,this.vm.running=!1,this.animationFrameId!==null)cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null}reset(){this.vm.reset()}step(){if(this.vm.virtualMemory===null)throw Error("Sysout not loaded");i0(this.vm)}getState(){return{pc:this.vm.pc,sp:this.vm.getStackPtrOffset(),fp:this.vm.getFramePtrOffset(),running:this.vm.running}}hasTrace(){return this.tracer!==null&&this.tracer.export().length>0}exportTrace(){if(this.tracer)return this.tracer.export();return""}}var R=null,r=document.getElementById("fileDropZone"),A$=document.getElementById("fileInput"),N7=document.getElementById("fileInfo"),C7=document.getElementById("displayCanvas"),x$=document.getElementById("startBtn"),N$=document.getElementById("stopBtn"),C$=document.getElementById("resetBtn"),I$=document.getElementById("stepBtn"),N0=document.getElementById("statusDisplay"),I7=document.getElementById("pcValue"),R7=document.getElementById("spValue"),k7=document.getElementById("fpValue"),b7=document.getElementById("fpsValue"),E7=document.getElementById("traceEnabled"),R$=document.getElementById("exportTraceBtn"),c0=document.getElementById("errorDisplay");r.addEventListener("dragover",($)=>{$.preventDefault(),r.classList.add("dragover")});r.addEventListener("dragleave",()=>{r.classList.remove("dragover")});r.addEventListener("drop",async($)=>{$.preventDefault(),r.classList.remove("dragover");let q=$.dataTransfer?.files;if(q&&q.length>0)await k$(q[0])});A$.addEventListener("change",async($)=>{let q=$.target.files;if(q&&q.length>0)await k$(q[0])});r.addEventListener("click",()=>{A$.click()});x$.addEventListener("click",()=>{if(R)R.start(),q0(!0)});N$.addEventListener("click",()=>{if(R)R.stop(),q0(!1)});C$.addEventListener("click",()=>{if(R)R.reset(),q0(!1)});I$.addEventListener("click",()=>{if(R)R.step()});R$.addEventListener("click",()=>{if(R){let $=R.exportTrace();if($){let q=new Blob([$],{type:"text/plain"}),Q=URL.createObjectURL(q),j=document.createElement("a");j.href=Q,j.download="taiko_trace.txt",j.click(),URL.revokeObjectURL(Q)}}});async function k$($){try{F$(null),N0.innerHTML="<p>Loading file...</p>";let q=await $.arrayBuffer();N7.textContent=`File: ${$.name} (${($.size/1024).toFixed(2)} KB)`,N0.innerHTML="<p>Initializing emulator...</p>",R=new f0(C7,{enableTracing:E7.checked}),await R.loadSysout(q),N0.innerHTML="<p>Emulator ready</p>",q0(!1),T7()}catch(q){F$(q),N0.innerHTML="<p>Error loading file</p>"}}function q0($){x$.disabled=!R||$,N$.disabled=!R||!$,C$.disabled=!R,I$.disabled=!R||$,R$.disabled=!R||!R.hasTrace()}var w$=performance.now(),p0=0,L$=0;function T7(){function $(){if(R){let q=R.getState();I7.textContent=`0x${q.pc.toString(16)}`,R7.textContent=`0x${q.sp.toString(16)}`,k7.textContent=`0x${q.fp.toString(16)}`,p0++;let Q=performance.now();if(Q-w$>=1000)L$=p0,p0=0,w$=Q;b7.textContent=L$.toString(),q0(q.running)}requestAnimationFrame($)}requestAnimationFrame($)}function F$($){if($)c0.style.display="block",c0.innerHTML=`
            <h3>Error</h3>
            <pre>${$.message}
${$.stack}</pre>
        `;else c0.style.display="none"}q0(!1);
