var s=5603,O=512,E=512;var l=65536,i=10;var F=0;var M=3758096384;var X0=2883584,Y0=655360,Z0=786432,U0=196608,B0=1314816;class v{static lispPtrToByte($){return $*2}static byteToLispPtr($){return Math.floor($/2)}static getVirtualPage($){return Math.floor($/E)}static getPageOffset($){return $%E}static getVirtualAddressBase($){return $*E}}class c{static getFilePageForVirtualPage($,Q){for(let J=0;J<$.length;J++)if(($[J]&65535)===Q)return J;return null}static getPageOK($,Q){if(Q<$.length)return $[Q]>>16&65535;return 0}static getFileOffset($){return $*512}static getVirtualPage($){return $&65535}static getPageStatus($){return $>>16&65535}}class I{static needsByteSwap($,Q){let J=Math.floor(Q/4)+1;return $<J}static swapU32($){return($&255)<<24|($&65280)<<8|($&16711680)>>8|($&4278190080)>>>24}static swapU16($){return($&255)<<8|($&65280)>>8}static applyXorAddressing($){return $^3}static readWordXor($,Q){let J=Q^3,j=Q+1^3,W=J<$.length?$[J]:0,K=j<$.length?$[j]:0;return W|K<<8}static readWordLittleEndian($,Q){let J=Q<$.length?$[Q]:0,j=Q+1<$.length?$[Q+1]:0;return J|j<<8}static readByteXor($,Q){if(Q<$.length){let J=Q^3;if(J<$.length)return $[J]}return null}}class G0{static readByte($,Q){if(Q>=0&&Q<$.length)return $[Q];return null}static readByteXor($,Q){return I.readByteXor($,Q)}static readInstructionBytes($,Q,J){let j=Math.min(Q+J,$.length);if(Q<j&&Q>=0)return $.slice(Q,j);return new Uint8Array(0)}static readDLword($,Q){if(Q>=0&&Q+1<$.length)return $[Q]|$[Q+1]<<8;return 0}static readDLwordXor($,Q){return I.readWordXor($,Q)}static readLispPTR($,Q){let J=this.readDLword($,Q);return this.readDLword($,Q+2)<<16|J}static writeDLword($,Q,J){if(Q>=0&&Q+1<$.length)$[Q]=J&255,$[Q+1]=J>>8&255}static writeLispPTR($,Q,J){this.writeDLword($,Q,J&65535),this.writeDLword($,Q+2,J>>16&65535)}static readJumpOffset($,Q){return I.readWordXor($,Q+1)<<16>>16}static readJumpOffsetRaw($,Q){return I.readWordLittleEndian($,Q+1)<<16>>16}}class z{static Address=v;static FPtoVP=c;static Endianness=I;static Access=G0}class p{stackBase;stackPtr;stackEnd;currentFrame=null;virtualMemory=null;fptovpTable=null;atomSpaceOffset=0;defSpaceOffset=0;valSpaceOffset=0;plistSpaceOffset=0;dtdOffset=0;pc=0;returnPc=null;funcObj=null;pvar=null;ivar=null;topOfStack=0;cstkptrl=null;stopRequested=!1;running=!1;totalInstructionCount=0;stepCapActive=!1;maxSteps=null;displayRegion=null;displayWidth=0;displayHeight=0;displayRegionOffset=0;constructor($=65536){this.stackBase=l*2,this.stackPtr=this.stackBase,this.stackEnd=this.stackBase-$}initializeMemory($,Q,J,j,W,K,Z){this.virtualMemory=$,this.fptovpTable=Q,this.atomSpaceOffset=J,this.defSpaceOffset=j,this.valSpaceOffset=W,this.plistSpaceOffset=K,this.dtdOffset=Z}initializeDisplay($,Q,J){if(this.displayWidth=Q,this.displayHeight=J,this.displayRegionOffset=z.Address.lispPtrToByte($),this.virtualMemory&&this.displayRegionOffset<this.virtualMemory.length){let j=Math.floor(Q*J/16),W=this.displayRegionOffset+j*2;if(W<=this.virtualMemory.length){let K=this.virtualMemory.buffer.slice(this.virtualMemory.byteOffset+this.displayRegionOffset,this.virtualMemory.byteOffset+W);this.displayRegion=new Uint16Array(K)}}}getDisplayRegion(){return this.displayRegion}getStackPtrOffset(){if(this.virtualMemory===null)return 0;let $=this.stackPtr,J=this.stackBase-$;return Math.floor(J/2)}getFramePtrOffset(){if(this.currentFrame===null)return 0;return this.getStackPtrOffset()}readTopOfStackFromMemory(){if(this.virtualMemory===null||this.cstkptrl===null)return 0;let $=this.cstkptrl-4;if($>=0&&$+4<=this.virtualMemory.length){let Q=this.virtualMemory[$]|this.virtualMemory[$+1]<<8;return(this.virtualMemory[$+2]|this.virtualMemory[$+3]<<8)<<16|Q}return 0}initCSTKPTRLFromCurrentStackPTR(){this.cstkptrl=this.stackPtr}syncTopOfStack(){this.topOfStack=this.readTopOfStackFromMemory()}reset(){this.pc=0,this.returnPc=null,this.stopRequested=!1,this.running=!1,this.totalInstructionCount=0,this.topOfStack=0,this.cstkptrl=null,this.currentFrame=null,this.funcObj=null,this.pvar=null,this.ivar=null,this.stackPtr=this.stackBase}}var w;((q)=>{q[q.NIL=104]="NIL";q[q.T=105]="T";q[q.CONST_0=106]="CONST_0";q[q.CONST_1=107]="CONST_1";q[q.ACONST=103]="ACONST";q[q.SIC=108]="SIC";q[q.SNIC=109]="SNIC";q[q.SICX=110]="SICX";q[q.GCONST=111]="GCONST";q[q.FN0=8]="FN0";q[q.FN1=9]="FN1";q[q.FN2=10]="FN2";q[q.FN3=11]="FN3";q[q.FN4=12]="FN4";q[q.FNX=13]="FNX";q[q.APPLYFN=14]="APPLYFN";q[q.CHECKAPPLY=15]="CHECKAPPLY";q[q.RETURN=16]="RETURN";q[q.BIND=17]="BIND";q[q.UNBIND=18]="UNBIND";q[q.DUNBIND=19]="DUNBIND";q[q.RPLPTR_N=20]="RPLPTR_N";q[q.GCREF=21]="GCREF";q[q.ASSOC=22]="ASSOC";q[q.GVAR_=23]="GVAR_";q[q.CAR=1]="CAR";q[q.CDR=2]="CDR";q[q.NTYPX=4]="NTYPX";q[q.CONS=26]="CONS";q[q.CMLASSOC=27]="CMLASSOC";q[q.FMEMB=28]="FMEMB";q[q.CMLMEMBER=29]="CMLMEMBER";q[q.FINDKEY=30]="FINDKEY";q[q.CREATECELL=31]="CREATECELL";q[q.WRTPTRTAG=54]="WRTPTRTAG";q[q.BIN=32]="BIN";q[q.BOUT=33]="BOUT";q[q.RPLCONS=38]="RPLCONS";q[q.LISTGET=39]="LISTGET";q[q.ELT=40]="ELT";q[q.NTHCHC=41]="NTHCHC";q[q.SETA=42]="SETA";q[q.RPLCHARCODE=43]="RPLCHARCODE";q[q.EVAL=44]="EVAL";q[q.ENVCALL=45]="ENVCALL";q[q.TYPECHECK=46]="TYPECHECK";q[q.BUSBLT=48]="BUSBLT";q[q.MISC8=49]="MISC8";q[q.UBFLOAT3=50]="UBFLOAT3";q[q.RPLACA=24]="RPLACA";q[q.RPLACD=25]="RPLACD";q[q.TYPEP=5]="TYPEP";q[q.DTEST=6]="DTEST";q[q.UNWIND=7]="UNWIND";q[q.MISCN=36]="MISCN";q[q.POPDISP=34]="POPDISP";q[q.RESTLIST=35]="RESTLIST";q[q.GVAR=96]="GVAR";q[q.ARG0=97]="ARG0";q[q.PVARX_=95]="PVARX_";q[q.IVARX_=98]="IVARX_";q[q.FVARX_=99]="FVARX_";q[q.POP=191]="POP";q[q.POP_N=192]="POP_N";q[q.ATOMCELL_N=193]="ATOMCELL_N";q[q.GETBASEBYTE=194]="GETBASEBYTE";q[q.INSTANCEP=195]="INSTANCEP";q[q.BLT=196]="BLT";q[q.MISC10=197]="MISC10";q[q.PUTBASEBYTE=199]="PUTBASEBYTE";q[q.GETBASE_N=200]="GETBASE_N";q[q.ITIMES2=201]="ITIMES2";q[q.GETBITS_N_FD=202]="GETBITS_N_FD";q[q.PUTBASE_N=205]="PUTBASE_N";q[q.PUTBASEPTR_N=206]="PUTBASEPTR_N";q[q.PUTBITS_N_FD=207]="PUTBITS_N_FD";q[q.ADDBASE=208]="ADDBASE";q[q.VAG2=209]="VAG2";q[q.HILOC=210]="HILOC";q[q.LOLOC=211]="LOLOC";q[q.PLUS2=212]="PLUS2";q[q.DIFFERENCE=213]="DIFFERENCE";q[q.TIMES2=214]="TIMES2";q[q.QUOTIENT=215]="QUOTIENT";q[q.CMLEQUAL=204]="CMLEQUAL";q[q.IPLUS2=216]="IPLUS2";q[q.IDIFFERENCE=217]="IDIFFERENCE";q[q.LLSH8=218]="LLSH8";q[q.IQUOTIENT=219]="IQUOTIENT";q[q.IREMAINDER=220]="IREMAINDER";q[q.IPLUS_N=221]="IPLUS_N";q[q.IDIFFERENCE_N=222]="IDIFFERENCE_N";q[q.BASE_LESSTHAN=223]="BASE_LESSTHAN";q[q.LLSH1=224]="LLSH1";q[q.LRSH1=226]="LRSH1";q[q.LRSH8=227]="LRSH8";q[q.LOGOR2=228]="LOGOR2";q[q.LOGAND2=229]="LOGAND2";q[q.LOGXOR2=230]="LOGXOR2";q[q.LSH=231]="LSH";q[q.GETBASEPTR_N=236]="GETBASEPTR_N";q[q.AREF2=238]="AREF2";q[q.UBFLOAT1=237]="UBFLOAT1";q[q.UBFLOAT2=225]="UBFLOAT2";q[q.FPLUS2=232]="FPLUS2";q[q.FDIFFERENCE=233]="FDIFFERENCE";q[q.FTIMES2=234]="FTIMES2";q[q.FQUOTIENT=235]="FQUOTIENT";q[q.ASET2=239]="ASET2";q[q.TYPEMASK_N=51]="TYPEMASK_N";q[q.MISC7=56]="MISC7";q[q.EQL=58]="EQL";q[q.DRAWLINE=59]="DRAWLINE";q[q.STORE_N=60]="STORE_N";q[q.RAID=62]="RAID";q[q.COPY_N=61]="COPY_N";q[q.RECLAIMCELL=122]="RECLAIMCELL";q[q.GCSCAN1=123]="GCSCAN1";q[q.GCSCAN2=124]="GCSCAN2";q[q.CONTEXTSWITCH=126]="CONTEXTSWITCH";q[q.RETCALL=127]="RETCALL";q[q.FGREATERP=242]="FGREATERP";q[q.IGREATERP=241]="IGREATERP";q[q.GREATERP=243]="GREATERP";q[q.EQ=240]="EQ";q[q.EQUAL=244]="EQUAL";q[q.MAKENUMBER=245]="MAKENUMBER";q[q.BOXIPLUS=246]="BOXIPLUS";q[q.BOXIDIFFERENCE=247]="BOXIDIFFERENCE";q[q.FLOATBLT=248]="FLOATBLT";q[q.FFTSTEP=249]="FFTSTEP";q[q.MISC3=250]="MISC3";q[q.MISC4=251]="MISC4";q[q.UPCTRACE=252]="UPCTRACE";q[q.CL_EQUAL=255]="CL_EQUAL";q[q.SWAP=253]="SWAP";q[q.NOP=254]="NOP";q[q.JUMP0=128]="JUMP0";q[q.JUMP1=129]="JUMP1";q[q.JUMP2=130]="JUMP2";q[q.JUMP3=131]="JUMP3";q[q.JUMP4=132]="JUMP4";q[q.JUMP5=133]="JUMP5";q[q.JUMP6=134]="JUMP6";q[q.JUMP7=135]="JUMP7";q[q.JUMP8=136]="JUMP8";q[q.JUMP9=137]="JUMP9";q[q.JUMP10=138]="JUMP10";q[q.JUMP11=139]="JUMP11";q[q.JUMP12=140]="JUMP12";q[q.JUMP13=141]="JUMP13";q[q.JUMP14=142]="JUMP14";q[q.JUMP15=143]="JUMP15";q[q.FJUMP0=144]="FJUMP0";q[q.FJUMP1=145]="FJUMP1";q[q.FJUMP2=146]="FJUMP2";q[q.FJUMP3=147]="FJUMP3";q[q.FJUMP4=148]="FJUMP4";q[q.FJUMP5=149]="FJUMP5";q[q.FJUMP6=150]="FJUMP6";q[q.FJUMP7=151]="FJUMP7";q[q.FJUMP8=152]="FJUMP8";q[q.FJUMP9=153]="FJUMP9";q[q.FJUMP10=154]="FJUMP10";q[q.FJUMP11=155]="FJUMP11";q[q.FJUMP12=156]="FJUMP12";q[q.FJUMP13=157]="FJUMP13";q[q.FJUMP14=158]="FJUMP14";q[q.FJUMP15=159]="FJUMP15";q[q.TJUMP0=160]="TJUMP0";q[q.TJUMP1=161]="TJUMP1";q[q.TJUMP2=162]="TJUMP2";q[q.TJUMP3=163]="TJUMP3";q[q.TJUMP4=164]="TJUMP4";q[q.TJUMP5=165]="TJUMP5";q[q.TJUMP6=166]="TJUMP6";q[q.TJUMP7=167]="TJUMP7";q[q.TJUMP8=168]="TJUMP8";q[q.TJUMP9=169]="TJUMP9";q[q.TJUMP10=170]="TJUMP10";q[q.TJUMP11=171]="TJUMP11";q[q.TJUMP12=172]="TJUMP12";q[q.TJUMP13=173]="TJUMP13";q[q.TJUMP14=174]="TJUMP14";q[q.TJUMP15=175]="TJUMP15";q[q.JUMPX=176]="JUMPX";q[q.JUMPXX=177]="JUMPXX";q[q.FJUMPX=178]="FJUMPX";q[q.TJUMPX=179]="TJUMPX";q[q.NFJUMPX=180]="NFJUMPX";q[q.NTJUMPX=181]="NTJUMPX";q[q.AREF1=182]="AREF1";q[q.ASET1=183]="ASET1";q[q.PVARSETPOP0=184]="PVARSETPOP0";q[q.PVARSETPOP1=185]="PVARSETPOP1";q[q.PVARSETPOP2=186]="PVARSETPOP2";q[q.PVARSETPOP3=187]="PVARSETPOP3";q[q.PVARSETPOP4=188]="PVARSETPOP4";q[q.PVARSETPOP5=189]="PVARSETPOP5";q[q.PVARSETPOP6=190]="PVARSETPOP6";q[q.IVAR0=64]="IVAR0";q[q.IVAR1=65]="IVAR1";q[q.IVAR2=66]="IVAR2";q[q.IVAR3=67]="IVAR3";q[q.IVAR4=68]="IVAR4";q[q.IVAR5=69]="IVAR5";q[q.IVAR6=70]="IVAR6";q[q.IVARX=71]="IVARX";q[q.PVAR0=72]="PVAR0";q[q.PVAR1=73]="PVAR1";q[q.PVAR2=74]="PVAR2";q[q.PVAR3=75]="PVAR3";q[q.PVAR4=76]="PVAR4";q[q.PVAR5=77]="PVAR5";q[q.PVAR6=78]="PVAR6";q[q.PVARX=79]="PVARX";q[q.FVAR0=80]="FVAR0";q[q.FVAR1=81]="FVAR1";q[q.FVAR2=82]="FVAR2";q[q.FVAR3=83]="FVAR3";q[q.FVAR4=84]="FVAR4";q[q.FVAR5=85]="FVAR5";q[q.FVAR6=86]="FVAR6";q[q.FVARX=87]="FVARX";q[q.PVAR_0=88]="PVAR_0";q[q.PVAR_1=89]="PVAR_1";q[q.PVAR_2=90]="PVAR_2";q[q.PVAR_3=91]="PVAR_3";q[q.PVAR_4=92]="PVAR_4";q[q.PVAR_5=93]="PVAR_5";q[q.PVAR_6=94]="PVAR_6";q[q.COPY=100]="COPY";q[q.MYARGCOUNT=101]="MYARGCOUNT";q[q.MYALINK=102]="MYALINK";q[q.STKSCAN=47]="STKSCAN";q[q.SLRETURN=63]="SLRETURN"})(w||={});function V0($){if($>=128&&$<=143)return 1;if($>=144&&$<=159)return 1;if($>=160&&$<=175)return 1;if($===176||$===178||$===179||$===180||$===181)return 3;if($===177)return 5;return 1}function D0($){if($ in w)return $;return null}function H0($,Q){if($.virtualMemory===null)return null;let J=$.virtualMemory,j=z.Access.readByteXor(J,Q);if(j===null)return null;let W=D0(j);if(W===null)return null;let K=V0(W);if(Q+K>J.length)return null;let Z=new Uint8Array(Math.max(0,K-1));for(let U=0;U<Z.length;U++){let G=Q+U+1,V=z.Access.readByteXor(J,G);if(V===null)return null;Z[U]=V}return{opcode:W,operands:Z,length:K}}var L0=new Map;function X($,Q){L0.set($,Q)}function n0($){return L0.get($)??null}function T0($,Q){let J=n0(Q.opcode);if(J)return J($,Q);return null}function Y($,Q){if($.virtualMemory===null)return;if($.topOfStack=Q,$.cstkptrl===null)$.cstkptrl=$.stackPtr;else $.cstkptrl+=4;if($.cstkptrl>=0&&$.cstkptrl+4<=$.virtualMemory.length)z.Access.writeLispPTR($.virtualMemory,$.cstkptrl,Q);$.stackPtr=$.cstkptrl}function B($){if($.virtualMemory===null)return 0;let Q=$.topOfStack;if($.cstkptrl!==null&&$.cstkptrl>=4)if($.cstkptrl-=4,$.cstkptrl>=0&&$.cstkptrl+4<=$.virtualMemory.length)$.topOfStack=z.Access.readLispPTR($.virtualMemory,$.cstkptrl);else $.topOfStack=0;else $.topOfStack=0;return $.stackPtr=$.cstkptrl??$.stackBase,Q}function f0($,Q){return Y($,0),null}function s0($,Q){return Y($,1),null}function O0($,Q){return Y($,0),null}function v0($,Q){return Y($,1),null}function c0($,Q){if($.virtualMemory===null)return null;let J=z.Access.readByteXor($.virtualMemory,$.pc+1);if(J===null)return null;let W=14680064|J;return Y($,W),null}X(104,f0);X(105,s0);X(106,O0);X(107,v0);X(103,c0);function p0($,Q){return B($),null}function d0($,Q){if($.virtualMemory===null)return null;let J=z.Access.readByteXor($.virtualMemory,$.pc+1);if(J===null)return null;let j=J;for(let W=0;W<j;W++)B($);return null}X(191,p0);X(192,d0);function b($){return($&14680064)===14680064}function C($){let Q=$&1048575;if(Q&524288)return Q|4293918720;return Q}function n($){return 14680064|$&1048575}function d($){let Q=B($),J=$.topOfStack;if(b(J)&&b(Q)){let j=C(J),W=C(Q),K=j+W;$.topOfStack=n(K)}else $.topOfStack=J+Q&16777215;return $.topOfStack}function t($){let Q=B($),J=$.topOfStack;if(b(J)&&b(Q)){let j=C(J),W=C(Q),K=j-W;$.topOfStack=n(K)}else $.topOfStack=J-Q&16777215;return $.topOfStack}function r($){let Q=B($),J=$.topOfStack;if(b(J)&&b(Q)){let j=C(J),W=C(Q),K=j*W;$.topOfStack=n(K)}else $.topOfStack=J*Q&16777215;return $.topOfStack}function F0($){let Q=B($),J=$.topOfStack;if(b(J)&&b(Q)){let j=C(J),W=C(Q);if(W===0)$.topOfStack=0;else{let K=Math.floor(j/W);$.topOfStack=n(K)}}else $.topOfStack=0;return $.topOfStack}function w0($){return d($)}function k0($){return t($)}function A0($){return r($)}function t0($,Q){return d($),null}function r0($,Q){return t($),null}function a0($,Q){return r($),null}function m0($,Q){return F0($),null}function o0($,Q){return w0($),null}function e0($,Q){return k0($),null}function $$($,Q){return A0($),null}X(212,t0);X(213,r0);X(214,a0);X(215,m0);X(216,o0);X(217,e0);X(201,$$);class _{static getDefCell($,Q,J){let j=Q+J*4;if(j+4<=$.length){let W=z.Access.readLispPTR($,j),K=W&2147483648?1:0,Z=W>>24&127;return{defpointer:W&2147483647,ccodep:K,argtype:Z}}return null}static isCCode($){return $.ccodep!==0}static getFunctionHeaderPtr($){return $.defpointer&2147483647}static readFunctionHeader($,Q){let J=z.Address.lispPtrToByte(Q);if(J+16>$.length)return null;let j=z.Access.readDLword($,J),W=z.Access.readDLword($,J+2),K=z.Access.readDLword($,J+4),Z=z.Access.readDLword($,J+6),U=$[J+8],G=U>>7&1,V=U>>6&1,L=U>>4&3,D=U&15,k=$[J+9]<<16|$[J+10]<<8|$[J+11],P=D<<24|k,R=z.Access.readDLword($,J+12),g=$[J+14],A=$[J+15],S=new Int16Array([W])[0],K0=new Int16Array([K])[0];return{stkmin:j,na:S,pv:K0,startpc:Z,nil4:G,byteswapped:V,argtype:L,framename:P,ntsize:R,nlocals:g,fvaroffset:A}}}var N0=1073741824,q$=2147483648,R0=4294967295;function u($,Q,J){if($.virtualMemory===null)return null;let j;if(Q.opcode===13){if(Q.operands.length<2)return null;J=Q.operands[0],j=Q.operands[1]}else{if(Q.operands.length<1)return null;j=Q.operands[0]}let W=_.getDefCell($.virtualMemory,$.atomSpaceOffset,j);if(!W)return console.warn(`FN: Definition cell not found for atom index ${j}`),null;if(_.isCCode(W))return console.warn(`FN: C code functions not yet supported for atom index ${j}`),null;let K=_.getFunctionHeaderPtr(W);if(K===0)return console.warn(`FN: Function header pointer is 0 for atom index ${j}`),null;let Z=_.readFunctionHeader($.virtualMemory,K);if(!Z)return console.warn(`FN: Failed to read function header at 0x${K.toString(16)}`),null;let U=Q.length,G=$.pc-($.funcObj||0)+U,V=$.stackPtr-J*4+4,L=(V-$.stackBase)/2;if($.ivar=V,Y($,$.topOfStack),Z.na>=0){let A=J-Z.na;if(A<0)for(let S=0;S<-A;S++)Y($,F);else if(A>0){if($.stackPtr-=A*4,$.cstkptrl!==null)$.cstkptrl-=A}}let D=q$|L&65535;Y($,D);let k=($.stackPtr-$.stackBase)/2,P=N0<<16|k&65535;Y($,P);let R=$.stackPtr;if(z.Access.writeLispPTR($.virtualMemory,R,K),$.stackPtr+=i*2,$.cstkptrl=$.stackPtr,$.pvar=$.stackPtr,Z.pv>=0)for(let A=Z.pv;A>=0;A--)Y($,R0),Y($,R0);Y($,F);let g=z.Address.lispPtrToByte(K);return $.pc=g+Z.startpc+1,$.funcObj=g,$.syncTopOfStack(),null}function Q$($,Q){return u($,Q,0)}function J$($,Q){return u($,Q,1)}function j$($,Q){return u($,Q,2)}function W$($,Q){return u($,Q,3)}function z$($,Q){return u($,Q,4)}function K$($,Q){return u($,Q,-1)}function X$($,Q){if($.virtualMemory===null||$.cstkptrl===null)return null;let J=$.topOfStack,j=!1,W=$.cstkptrl;for(let S=0;S<1000;S++){if(W-=4,W<$.stackEnd||W>=$.stackBase)break;if((z.Access.readLispPTR($.virtualMemory,W)&N0)!==0){j=!0;break}}if(!j)return console.warn("RETURN: FX marker not found"),null;let K=W-4,U=z.Access.readLispPTR($.virtualMemory,K)&65535,G=$.stackBase+U*2;$.ivar=G;let V=z.Access.readDLword($.virtualMemory,W+4),D=z.Access.readDLword($.virtualMemory,W+6)<<16|V;if(!_.readFunctionHeader($.virtualMemory,D))return console.warn("RETURN: Failed to read function header"),null;let P=z.Access.readDLword($.virtualMemory,W+10),R=z.Address.lispPtrToByte(D);$.pc=R+P,$.funcObj=R;let A=(z.Access.readLispPTR($.virtualMemory,W)&65535)*2;return $.pvar=$.stackBase+A,$.stackPtr=W,$.cstkptrl=W,$.topOfStack=J,$.syncTopOfStack(),null}X(8,Q$);X(9,J$);X(10,j$);X(11,W$);X(12,z$);X(13,K$);X(16,X$);function Y$($,Q){if($.virtualMemory===null)return null;if(Q.operands.length<2)return null;return z.Access.readJumpOffset($.virtualMemory,$.pc)}function Z$($,Q){if($.virtualMemory===null||Q.operands.length<2)return null;if($.topOfStack===0)return z.Access.readJumpOffset($.virtualMemory,$.pc);return null}function U$($,Q){if($.virtualMemory===null||Q.operands.length<2)return null;if($.topOfStack!==0)return z.Access.readJumpOffset($.virtualMemory,$.pc);return null}X(176,Y$);X(178,Z$);X(179,U$);function B$($,Q){if($.virtualMemory===null||Q.operands.length<1)return null;let J=B($),j=Q.operands[0],K=z.Address.lispPtrToByte(J&2147483647)+j;if(K+2<=$.virtualMemory.length){let Z=z.Access.readDLword($.virtualMemory,K);Y($,M|Z)}else Y($,0);return null}function G$($,Q){if($.virtualMemory===null||Q.operands.length<1)return null;let J=B($),j=B($),W=Q.operands[0];if((J&3758096384)!==M)return console.warn("PUTBASE_N: Value is not SMALLP"),Y($,j),null;let Z=z.Address.lispPtrToByte(j&2147483647)+W,U=J&65535;if(Z+2<=$.virtualMemory.length)z.Access.writeDLword($.virtualMemory,Z,U);return Y($,j),null}function V$($,Q){if($.virtualMemory===null||Q.operands.length<1)return null;let J=B($),j=Q.operands[0],K=z.Address.lispPtrToByte(J&2147483647)+j;if(K+4<=$.virtualMemory.length){let Z=z.Access.readLispPTR($.virtualMemory,K);Y($,Z&2147483647)}else Y($,0);return null}function D$($,Q){if($.virtualMemory===null||Q.operands.length<1)return null;let J=B($),j=B($),W=Q.operands[0],Z=z.Address.lispPtrToByte(j&2147483647)+W;if(Z+4<=$.virtualMemory.length)z.Access.writeLispPTR($.virtualMemory,Z,J&2147483647);return Y($,j),null}X(200,B$);X(205,G$);X(236,V$);X(206,D$);function H$($,Q){return null}function L$($,Q){return null}function T$($,Q){return null}function F$($,Q){return null}X(232,H$);X(233,L$);X(234,T$);X(235,F$);function w$($,Q){return null}function k$($,Q){return null}function A$($,Q){return null}X(196,w$);X(48,k$);X(59,A$);class a{static getValueCell($,Q,J){let j=Q+J*4;if(j+4<=$.length)return z.Access.readLispPTR($,j);return 0}static setValueCell($,Q,J,j){let W=Q+J*4;if(W+4<=$.length)z.Access.writeLispPTR($,W,j)}static getGlobalVarValueCellAddress($,Q,J){return Q+J*4}}class H{static readPVAR($,Q){if($.virtualMemory===null||$.pvar===null)return 0;let J=$.pvar+Q*4;if(J+4<=$.virtualMemory.length)return z.Access.readLispPTR($.virtualMemory,J);return 0}static writePVAR($,Q,J){if($.virtualMemory===null||$.pvar===null)return;let j=$.pvar+Q*4;if(j+4<=$.virtualMemory.length)z.Access.writeLispPTR($.virtualMemory,j,J)}static readIVAR($,Q){if($.virtualMemory===null||$.ivar===null)return 0;let J=$.ivar+Q*4;if(J+4<=$.virtualMemory.length)return z.Access.readLispPTR($.virtualMemory,J);return 0}static writeIVAR($,Q,J){if($.virtualMemory===null||$.ivar===null)return;let j=$.ivar+Q*4;if(j+4<=$.virtualMemory.length)z.Access.writeLispPTR($.virtualMemory,j,J)}static readFVAR($,Q){if($.virtualMemory===null||$.pvar===null)return 0;let J=$.pvar+Q*2;if(J+4<=$.virtualMemory.length){if((z.Access.readDLword($.virtualMemory,J)&32768)!==0)return 0;let W=z.Access.readDLword($.virtualMemory,J+2),K=z.Access.readDLword($.virtualMemory,J),U=((W&65535)<<16|K&65535)&268435455;if(U!==0){let G=z.Address.lispPtrToByte(U);if(G+4<=$.virtualMemory.length)return z.Access.readLispPTR($.virtualMemory,G)}}return 0}static readARG0($){if($.ivar!==null)return H.readIVAR($,0);return 0}static getCurrentFX($){if($.pvar===null)return null;return $.pvar-i*2}static readALink($){let Q=H.getCurrentFX($);if(Q===null||$.virtualMemory===null)return 0;if(Q+4<=$.virtualMemory.length)return z.Access.readDLword($.virtualMemory,Q+2);return 0}static readBLink($){let Q=H.getCurrentFX($);if(Q===null||$.virtualMemory===null)return 0;if(Q+18<=$.virtualMemory.length)return z.Access.readDLword($.virtualMemory,Q+16);return 0}static getArgCount($){if($.virtualMemory===null||$.pvar===null||$.ivar===null)return 0;let Q=H.getCurrentFX($);if(Q===null)return 0;let J=H.readALink($),j;if((J&1)===0)j=Q-4;else{let K=H.readBLink($);j=$.stackBase+K*2}let W=j-$.ivar>>2;return M|W&65535}static getALink($){if(H.getCurrentFX($)===null)return 0;let W=(H.readALink($)&65534)-i;return M|W&65535}static parseFrame($,Q){if($.virtualMemory===null)return null;let J=z.Address.lispPtrToByte(Q);if(J+20>$.virtualMemory.length)return null;return{flags_usecount:z.Access.readDLword($.virtualMemory,J),alink:z.Access.readDLword($.virtualMemory,J+2),lofnheader:z.Access.readDLword($.virtualMemory,J+4),hi1fnheader_hi2fnheader:z.Access.readDLword($.virtualMemory,J+6),nextblock:z.Access.readDLword($.virtualMemory,J+8),pc:z.Access.readDLword($.virtualMemory,J+10),lonametable:z.Access.readDLword($.virtualMemory,J+12),hi1nametable_hi2nametable:z.Access.readDLword($.virtualMemory,J+14),blink:z.Access.readDLword($.virtualMemory,J+16),clink:z.Access.readDLword($.virtualMemory,J+18)}}}function R$($,Q){if($.virtualMemory===null)return null;let J=z.Access.readByteXor($.virtualMemory,$.pc+1);if(J===null)return null;let j=J,W=a.getValueCell($.virtualMemory,$.valSpaceOffset,j);return Y($,W),null}function N$($,Q){let J=H.readARG0($);return Y($,J),null}function x$($,Q,J){let j=H.readIVAR($,J);return Y($,j),null}function I$($,Q){if($.virtualMemory===null||Q.operands.length<1)return null;let J=Q.operands[0],j=H.readIVAR($,J);return Y($,j),null}function x0($,Q,J){let j=H.readPVAR($,J);return Y($,j),null}function E$($,Q){if($.virtualMemory===null||Q.operands.length<1)return null;let J=Q.operands[0],j=H.readPVAR($,J);return Y($,j),null}function I0($,Q,J){let j=H.readFVAR($,J);return Y($,j),null}function b$($,Q){if($.virtualMemory===null||Q.operands.length<1)return null;let J=Q.operands[0];return I0($,Q,J)}function C$($,Q,J){let j=B($);return H.writePVAR($,J,j),null}function _$($,Q){if($.virtualMemory===null||Q.operands.length<1)return null;let J=Q.operands[0],j=B($);return H.writePVAR($,J,j),null}function P$($,Q){if($.virtualMemory===null||Q.operands.length<1)return null;let J=Q.operands[0],j=B($);return H.writeIVAR($,J,j),null}function S$($,Q){if($.virtualMemory===null||Q.operands.length<1)return null;let J=B($),j=Q.operands[0];if($.pvar===null)return Y($,J),null;let W=$.pvar+j*2;if(W+4<=$.virtualMemory.length){if((z.Access.readDLword($.virtualMemory,W)&32768)!==0)return console.warn(`FVARX_: Attempting to set unbound FVAR ${j} - name table lookup needed`),Y($,J),null;let Z=z.Access.readDLword($.virtualMemory,W+2),U=z.Access.readDLword($.virtualMemory,W),V=((Z&65535)<<16|U&65535)&268435455;if(V!==0){let L=z.Address.lispPtrToByte(V);if(L+4<=$.virtualMemory.length)z.Access.writeLispPTR($.virtualMemory,L,J)}}return Y($,J),null}function h$($,Q,J){return x0($,Q,J)}function M$($,Q){let J=H.getArgCount($);return Y($,J),null}function u$($,Q){let J=H.getALink($);return Y($,J),null}X(96,R$);X(97,N$);for(let $=0;$<=6;$++)X(64+$,(Q,J)=>x$(Q,J,$));X(71,I$);for(let $=0;$<=6;$++)X(72+$,(Q,J)=>x0(Q,J,$));X(79,E$);var y$=[0,2,4,6,8,10,12];for(let $=0;$<=6;$++)X(80+$,(Q,J)=>I0(Q,J,y$[$]));X(87,b$);for(let $=0;$<=6;$++)X(184+$,(Q,J)=>C$(Q,J,$));X(95,_$);X(98,P$);X(99,S$);for(let $=0;$<=6;$++)X(88+$,(Q,J)=>h$(Q,J,$));X(101,M$);X(102,u$);var g$=128;var l$=254,E0=65535;var N=4,x=5,m=Math.floor((E-N)/x);class o{memory;plistSpaceOffset;dtdOffset;constructor($,Q,J){this.memory=$,this.plistSpaceOffset=Q,this.dtdOffset=J}readConsPage($){if($+N>this.memory.length)return null;let Q=this.memory[$],J=this.memory[$+1],j=z.Access.readDLword(this.memory,$+2);return{count:Q,next_cell:J,next_page:j}}writeConsPage($,Q){if($+N>this.memory.length)return;this.memory[$]=Q.count,this.memory[$+1]=Q.next_cell,z.Access.writeDLword(this.memory,$+2,Q.next_page)}readConsCell($){if($+x>this.memory.length)return null;let Q=z.Access.readLispPTR(this.memory,$),J=this.memory[$+4];return{car_field:Q,cdr_code:J}}writeConsCell($,Q){if($+x>this.memory.length)return;z.Access.writeLispPTR(this.memory,$,Q.car_field),this.memory[$+4]=Q.cdr_code}getNextConsPage(){let Q=this.dtdOffset+90;if(Q+32>this.memory.length)return 0;let J=z.Access.readDLword(this.memory,Q+28),W=z.Access.readDLword(this.memory,Q+30)<<16|J;if(W===0||W===E0)return 0;return z.Address.lispPtrToByte(W)}findFreeConsCell(){let $=this.getNextConsPage();if($===0)return null;while($!==0&&$!==E0){let Q=z.Address.lispPtrToByte($),J=this.readConsPage(Q);if(!J)break;if(J.count>0){let j=Q+N+J.next_cell*x,W=this.memory[j+4];return J.count--,J.next_cell=W,this.writeConsPage(Q,J),j}else $=J.next_page}return null}allocateNewConsPage(){let $=this.plistSpaceOffset,Q={count:m-1,next_cell:1,next_page:0};this.writeConsPage($,Q);for(let j=1;j<m-1;j++){let W=$+N+j*x;z.Access.writeLispPTR(this.memory,W,F),this.memory[W+4]=j+1}let J=$+N+(m-1)*x;return z.Access.writeLispPTR(this.memory,J,F),this.memory[J+4]=0,$}allocateConsCell($,Q){let J=null;if(Q===F){if(J=this.findFreeConsCell(),!J){let W=this.allocateNewConsPage();if(!W)return F;let K=this.readConsPage(W);if(!K)return F;J=W+N+K.next_cell*x,K.count--;let Z=this.memory[J+4];K.next_cell=Z,this.writeConsPage(W,K)}let j={car_field:$,cdr_code:g$};this.writeConsCell(J,j)}else{console.warn("CONS: Non-NIL CDR not yet fully implemented, using CDR_INDIRECT");let j=this.allocateNewConsPage();if(!j)return F;let W=this.readConsPage(j);if(!W||W.count<2)return F;let K=j+N+W.next_cell*x,Z=this.memory[K+4];W.next_cell=Z;let U=j+N+Z*x,G=this.memory[U+4];W.next_cell=G,W.count-=2,this.writeConsPage(j,W),z.Access.writeLispPTR(this.memory,K,Q),this.memory[K+4]=0;let V={car_field:$,cdr_code:l$};this.writeConsCell(U,V);let L=(K-j-N)/x;this.memory[U+4]=L,J=U}return z.Address.byteToLispPtr(J)}}var e=128,i$=128,b0=254;function $0($,Q){if(Q===0)return!1;if($.virtualMemory===null)return!1;return z.Address.lispPtrToByte(Q)<$.virtualMemory.length}function n$($,Q){if($.virtualMemory===null)return 0;if(Q===0)return 0;let J=z.Address.lispPtrToByte(Q);if(J+4>$.virtualMemory.length)return 0;return z.Access.readLispPTR($.virtualMemory,J)}function f$($,Q){if($.virtualMemory===null)return 0;if(Q===0)return 0;let J=z.Address.lispPtrToByte(Q);if(J+5>$.virtualMemory.length)return 0;let j=$.virtualMemory[J+4];if(j===e||j===0)return 0;else if((j&i$)!==0){let W=z.Address.getVirtualAddressBase(z.Address.getVirtualPage(J)),K=(j&127)<<1;return z.Address.byteToLispPtr(W+K)}else if(j===b0){let W=J+8;if(W+4>$.virtualMemory.length)return 0;return z.Access.readLispPTR($.virtualMemory,W)}else{let W=z.Address.getVirtualAddressBase(z.Address.getVirtualPage(J)),K=j<<1;return z.Address.byteToLispPtr(W+K)}}function s$($,Q){let J=B($),j=n$($,J);return Y($,j),null}function O$($,Q){let J=B($),j=f$($,J);return Y($,j),null}function v$($,Q){if($.virtualMemory===null)return null;let J=B($),j=B($),K=new o($.virtualMemory,$.plistSpaceOffset,$.dtdOffset).allocateConsCell(j,J);if(K===F)return console.warn("CONS: Failed to allocate cons cell"),Y($,F),null;return Y($,K),null}function c$($,Q){if($.virtualMemory===null)return null;let J=B($),j=B($);if(j===0){if(J!==0)return console.warn("RPLACA: Attempt to RPLACA NIL"),Y($,0),null;return Y($,0),null}if(!$0($,j))return console.warn("RPLACA: ARG not List"),Y($,j),null;let W=z.Address.lispPtrToByte(j);if(W+5>$.virtualMemory.length)return Y($,j),null;if($.virtualMemory[W+4]===b0){let Z=z.Access.readLispPTR($.virtualMemory,W),U=z.Address.lispPtrToByte(Z);if(U+4<=$.virtualMemory.length)z.Access.writeLispPTR($.virtualMemory,U,J)}else z.Access.writeLispPTR($.virtualMemory,W,J);return Y($,j),null}function p$($,Q){if($.virtualMemory===null)return null;let J=B($),j=B($);if(j===0){if(J!==0)return console.warn("RPLACD: Attempt to RPLACD NIL"),Y($,0),null;return Y($,0),null}if(!$0($,j))return console.warn("RPLACD: ARG not List"),Y($,j),null;let W=z.Address.lispPtrToByte(j);if(W+5>$.virtualMemory.length)return Y($,j),null;let K=$.virtualMemory[W+4];if(J===0)$.virtualMemory[W+4]=e;else console.warn("RPLACD: Non-NIL CDR coding not fully implemented, using CDR_INDIRECT"),$.virtualMemory[W+4]=e;return Y($,j),null}function d$($,Q){let J=$.topOfStack,j=$0($,J);return $.topOfStack=j?1:0,null}X(1,s$);X(2,O$);X(26,v$);X(24,c$);X(25,p$);X(5,d$);function t$($,Q){let J=$.topOfStack;return Y($,J),null}X(100,t$);function r$($,Q){if($.virtualMemory===null)return null;if(Q.operands.length<2)return null;let J=Q.operands[0],j=Q.operands[1],W=J>>4&15,K=J&15,G=$.stackPtr+20+(1+j)*4;for(let D=0;D<W;D++){let k=G-(D+1)*4;if(k>=0&&k+4<=$.virtualMemory.length)z.Access.writeLispPTR($.virtualMemory,k,F)}if(K===0)Y($,$.topOfStack);else{let D=G-(W+1)*4;if(D>=0&&D+4<=$.virtualMemory.length)z.Access.writeLispPTR($.virtualMemory,D,$.topOfStack);for(let k=1;k<K;k++){let P=B($),R=G-(W+k+1)*4;if(R>=0&&R+4<=$.virtualMemory.length)z.Access.writeLispPTR($.virtualMemory,R,P)}}let L=(~(W+K)&65535)<<16|j<<1&65535;return Y($,L),null}function a$($,Q){if($.virtualMemory===null||$.cstkptrl===null)return null;let J=!1,j=0,W=$.cstkptrl;for(let L=0;L<1000;L++){if(W-=4,W<$.stackEnd||W>=$.stackBase)break;let D=z.Access.readLispPTR($.virtualMemory,W);if((D&2147483648)!==0){J=!0,j=D,$.cstkptrl=W;break}}if(!J)return console.warn("UNBIND: Marker not found"),null;let K=~(j>>16)&65535,Z=(j&65535)>>1,G=$.stackPtr+20+(2+Z)*4,V=4294967295;for(let L=0;L<K;L++){let D=G-(L+1)*4;if(D>=0&&D+4<=$.virtualMemory.length)z.Access.writeLispPTR($.virtualMemory,D,V)}return $.syncTopOfStack(),null}function m$($,Q){return console.warn(`DUNBIND (0x${19 .toString(16)}) not implemented.`),null}X(17,r$);X(18,a$);X(19,m$);function o$($,Q){return $.initCSTKPTRLFromCurrentStackPTR(),$.syncTopOfStack(),e$($,Q)}function e$($,Q){let J=T0($,Q);if(J===null){let j=Q.opcode;if(j>=128&&j<=143)return j-128+1;if(j>=144&&j<=159){if($.topOfStack===0)return j-144+1;return null}if(j>=160&&j<=175){if($.topOfStack!==0)return j-160+1;return null}}return J}function q0($){if($.virtualMemory===null)return!1;if($.maxSteps!==null&&$.totalInstructionCount>=$.maxSteps)return $.stopRequested=!0,!1;if($.stopRequested)return!1;let Q=H0($,$.pc);if(Q===null)return $.stopRequested=!0,!1;let J=o$($,Q);if(J!==null){let j=$.pc+J;if(j<0||j>=$.virtualMemory.length)return $.stopRequested=!0,!1;if($.pc=j,J===0)$.pc+=Q.length}else $.pc+=Q.length;return $.totalInstructionCount++,!0}function $6($,Q){let J=new DataView($,Q),j={resetfxp:J.getUint16(0,!0),currentfxp:J.getUint16(2,!0),kbdfxp:J.getUint16(4,!0),subovfxp:J.getUint16(6,!0),gcfxp:J.getUint16(8,!0),hardreturnfxp:J.getUint16(10,!0),endofstack:J.getUint16(12,!0),faultfxp:J.getUint16(14,!0),minrversion:J.getUint16(16,!0),lversion:J.getUint16(18,!0),rversion:J.getUint16(20,!0),minbversion:J.getUint16(22,!0),machinetype:J.getUint16(24,!0),bversion:J.getUint16(26,!0),key:J.getUint16(28,!0),miscfxp:J.getUint16(30,!0),emulatorspace:J.getUint16(32,!0),serialnumber:J.getUint16(34,!0),nxtpmaddr:J.getUint16(36,!0),screenwidth:J.getUint16(38,!0),ndirtypages:J.getUint16(40,!0),nactivepages:J.getUint16(42,!0),filepnpmt0:J.getUint16(44,!0),filepnpmp0:J.getUint16(46,!0),filler1:J.getUint16(48,!0),teleraidfxp:J.getUint16(50,!0),filler3:J.getUint16(52,!0),filler2:J.getUint16(54,!0),userpswdaddr:J.getUint16(56,!0),usernameaddr:J.getUint16(58,!0),faulthi:J.getUint16(60,!0),stackbase:J.getUint16(62,!0),devconfig:J.getUint16(64,!0),faultlo:J.getUint16(66,!0),rpoffset:J.getUint16(68,!0),rptsize:J.getUint16(70,!0),embufvp:J.getUint16(72,!0),wasrptlast:J.getUint16(74,!0),nshost1:J.getUint16(76,!0),nshost0:J.getUint16(78,!0),mdszone:J.getUint16(80,!0),nshost2:J.getUint16(82,!0),emubuffers:J.getUint16(84,!0),mdszonelength:J.getUint16(86,!0),process_size:J.getUint16(88,!0),emubuflength:J.getUint16(90,!0),isfmap:J.getUint16(92,!0),storagefullstate:J.getUint16(94,!0),miscstackfn:J.getUint32(96,!0),miscstackarg1:J.getUint32(100,!0),miscstackarg2:J.getUint32(104,!0),miscstackresult:J.getUint32(108,!0),lastlockedfilepage:J.getUint16(112,!0),nrealpages:J.getUint16(114,!0),fptovpstart:J.getUint16(116,!0),lastdominofilepage:J.getUint16(118,!0),dl24bitaddressable:J.getUint16(120,!0),fakemousebits:J.getUint16(122,!0),realpagetableptr:J.getUint32(124,!0),fullspaceused:J.getUint16(128,!0),dllastvmempage:J.getUint16(130,!0),fakekbdad5:J.getUint16(132,!0),fakekbdad4:J.getUint16(134,!0)};if(j.key!==s)throw Error(`Invalid IFPAGE key: expected 0x${s.toString(16)}, got 0x${j.key.toString(16)}`);return j}function q6($,Q,J){let W=Math.floor(J/E)*4,K=O+144,Z=$.slice(K,K+W),U=new Uint32Array(Z);for(let G=0;G<U.length;G++)U[G]=z.Endianness.swapU32(U[G]);return U}function Q6($,Q){let j=new Uint8Array(1048576),W=new Uint8Array($),K=Math.min(W.length,j.length);return j.set(W.slice(0,K),0),j}function J6($,Q){let J=l*2,j=Q.currentfxp,W=J+j*2;if(W+14>$.length)return 0;let K=$[W+4]|$[W+5]<<8;return($[W+7]<<16|K)*2}async function C0($){let Q=$6($,O);if(Q===null)throw Error("Failed to parse IFPAGE");let J=q6($,Q,$.byteLength),j=Q6($,J),W=J6(j,Q),K=l*2,Z=z.Address.lispPtrToByte(X0),U=z.Address.lispPtrToByte(Y0),G=z.Address.lispPtrToByte(Z0),V=z.Address.lispPtrToByte(U0),L=z.Address.lispPtrToByte(B0);return{virtualMemory:j,fptovpTable:J,ifpage:Q,initialPC:W,initialSP:K,atomSpaceOffset:Z,defSpaceOffset:U,valSpaceOffset:G,plistSpaceOffset:V,dtdOffset:L}}class Q0{gl=null;canvas;program=null;texture=null;displayWidth=0;displayHeight=0;constructor($){this.canvas=$,this.initWebGL()}initWebGL(){let $=this.canvas.getContext("webgl2");if(!$)throw Error("WebGL 2.0 not supported");this.gl=$,this.program=this.createShaderProgram(),this.texture=$.createTexture(),$.bindTexture($.TEXTURE_2D,this.texture),$.texParameteri($.TEXTURE_2D,$.TEXTURE_MIN_FILTER,$.NEAREST),$.texParameteri($.TEXTURE_2D,$.TEXTURE_MAG_FILTER,$.NEAREST),$.texParameteri($.TEXTURE_2D,$.TEXTURE_WRAP_S,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_2D,$.TEXTURE_WRAP_T,$.CLAMP_TO_EDGE)}createShaderProgram(){if(!this.gl)throw Error("WebGL not initialized");let $=`#version 300 es
            in vec2 a_position;
            in vec2 a_texCoord;
            out vec2 v_texCoord;
            void main() {
                gl_Position = vec4(a_position, 0.0, 1.0);
                v_texCoord = a_texCoord;
            }
        `,Q=`#version 300 es
            precision highp float;
            uniform sampler2D u_texture;
            uniform vec2 u_resolution;
            in vec2 v_texCoord;
            out vec4 fragColor;
            void main() {
                vec2 coord = v_texCoord;
                vec4 color = texture(u_texture, coord);
                fragColor = color;
            }
        `,J=this.compileShader(this.gl.VERTEX_SHADER,$),j=this.compileShader(this.gl.FRAGMENT_SHADER,Q),W=this.gl.createProgram();if(!W)throw Error("Failed to create program");if(this.gl.attachShader(W,J),this.gl.attachShader(W,j),this.gl.linkProgram(W),!this.gl.getProgramParameter(W,this.gl.LINK_STATUS)){let K=this.gl.getProgramInfoLog(W);throw Error(`Program link failed: ${K}`)}return W}compileShader($,Q){if(!this.gl)throw Error("WebGL not initialized");let J=this.gl.createShader($);if(!J)throw Error("Failed to create shader");if(this.gl.shaderSource(J,Q),this.gl.compileShader(J),!this.gl.getShaderParameter(J,this.gl.COMPILE_STATUS)){let j=this.gl.getShaderInfoLog(J);throw this.gl.deleteShader(J),Error(`Shader compilation failed: ${j}`)}return J}updateDisplay($,Q,J){if(!this.gl||!this.texture||!this.program)return;this.displayWidth=Q,this.displayHeight=J;let j=new Uint8Array(Q*J*4);for(let W=0;W<$.length;W++){let K=$[W],Z=Math.floor(W/Q),U=W%Q,G=(Z*Q+U)*4,V=K&1;j[G]=V?255:0,j[G+1]=V?255:0,j[G+2]=V?255:0,j[G+3]=255}this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,Q,J,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,j)}render(){if(!this.gl||!this.program||!this.texture)return;this.gl.useProgram(this.program),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT);let $=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),Q=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,Q),this.gl.bufferData(this.gl.ARRAY_BUFFER,$,this.gl.STATIC_DRAW);let J=this.gl.getAttribLocation(this.program,"a_position"),j=this.gl.getAttribLocation(this.program,"a_texCoord");if(J>=0)this.gl.enableVertexAttribArray(J),this.gl.vertexAttribPointer(J,2,this.gl.FLOAT,!1,16,0);if(j>=0)this.gl.enableVertexAttribArray(j),this.gl.vertexAttribPointer(j,2,this.gl.FLOAT,!1,16,8);let W=this.gl.getUniformLocation(this.program,"u_resolution");if(W)this.gl.uniform2f(W,this.canvas.width,this.canvas.height);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}class J0{lines=[];lineNumber=0;logInstruction($,Q,J=!1){let j=this.formatTraceLine($,Q,J);this.lines.push(j),this.lineNumber++}formatTraceLine($,Q,J){let j=[];j.push(this.lineNumber.toString()),j.push(`0x${$.pc.toString(16)}`),j.push(w[Q.opcode]||`0x${Q.opcode.toString(16)}`),j.push(`0x${Q.opcode.toString(16)}`);let W=Array.from(Q.operands).map((Z)=>`0x${Z.toString(16).padStart(2,"0")}`).join(",");j.push(W||"-");let K=`PC=0x${$.pc.toString(16)} SP=0x${$.getStackPtrOffset().toString(16)} FP=0x${$.getFramePtrOffset().toString(16)} TOS=0x${$.topOfStack.toString(16)}`;return j.push(K),j.push("-"),j.push(`SP=0x${$.getStackPtrOffset().toString(16)} FP=0x${$.getFramePtrOffset().toString(16)}`),j.push(`TOS=0x${$.topOfStack.toString(16)}`),j.push("-"),j.push("-"),j.push("-"),j.push("-"),j.join("|")}export(){return this.lines.join(`
`)}clear(){this.lines=[],this.lineNumber=0}}class j0{vm;canvas;options;traceEnabled=!1;traceBuffer=[];renderer=null;tracer=null;animationFrameId=null;constructor($,Q={}){this.canvas=$,this.options=Q,this.vm=new p,this.traceEnabled=Q.enableTracing??!1;try{this.renderer=new Q0($)}catch(J){console.error("Failed to initialize WebGL:",J)}if(this.traceEnabled)this.tracer=new J0;if(Q.maxSteps!==void 0)this.vm.maxSteps=Q.maxSteps,this.vm.stepCapActive=!0}async loadSysout($){let Q=await C0($);this.vm.initializeMemory(Q.virtualMemory,Q.fptovpTable,Q.atomSpaceOffset,Q.defSpaceOffset,Q.valSpaceOffset,Q.plistSpaceOffset,Q.dtdOffset),this.vm.pc=Q.initialPC,this.vm.stackPtr=Q.initialSP,this.vm.cstkptrl=Q.initialSP;let J=Q.ifpage.screenwidth||1024,j=768,W=2097152;this.vm.initializeDisplay(W,J,j)}start(){if(this.vm.virtualMemory===null)throw Error("Sysout not loaded");this.runExecutionLoop()}runExecutionLoop(){let $=()=>{if(this.vm.stopRequested||!this.vm.running){this.animationFrameId=null;return}let Q=1000;for(let J=0;J<Q&&!this.vm.stopRequested;J++)if(!q0(this.vm))break;this.updateDisplay(),this.animationFrameId=requestAnimationFrame($)};this.vm.running=!0,this.vm.stopRequested=!1,this.animationFrameId=requestAnimationFrame($)}updateDisplay(){if(!this.renderer||!this.vm.displayRegion)return;let $=this.vm.displayRegion,Q=this.vm.displayWidth,J=this.vm.displayHeight;if(Q>0&&J>0)this.renderer.updateDisplay($,Q,J),this.renderer.render()}stop(){if(this.vm.stopRequested=!0,this.vm.running=!1,this.animationFrameId!==null)cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null}reset(){this.vm.reset()}step(){if(this.vm.virtualMemory===null)throw Error("Sysout not loaded");q0(this.vm)}getState(){return{pc:this.vm.pc,sp:this.vm.getStackPtrOffset(),fp:this.vm.getFramePtrOffset(),running:this.vm.running}}hasTrace(){return this.tracer!==null&&this.tracer.export().length>0}exportTrace(){if(this.tracer)return this.tracer.export();return""}}var T=null,h=document.getElementById("fileDropZone"),h0=document.getElementById("fileInput"),j6=document.getElementById("fileInfo"),W6=document.getElementById("displayCanvas"),M0=document.getElementById("startBtn"),u0=document.getElementById("stopBtn"),y0=document.getElementById("resetBtn"),g0=document.getElementById("stepBtn"),f=document.getElementById("statusDisplay"),z6=document.getElementById("pcValue"),K6=document.getElementById("spValue"),X6=document.getElementById("fpValue"),Y6=document.getElementById("fpsValue"),Z6=document.getElementById("traceEnabled"),l0=document.getElementById("exportTraceBtn"),W0=document.getElementById("errorDisplay");h.addEventListener("dragover",($)=>{$.preventDefault(),h.classList.add("dragover")});h.addEventListener("dragleave",()=>{h.classList.remove("dragover")});h.addEventListener("drop",async($)=>{$.preventDefault(),h.classList.remove("dragover");let Q=$.dataTransfer?.files;if(Q&&Q.length>0)await i0(Q[0])});h0.addEventListener("change",async($)=>{let Q=$.target.files;if(Q&&Q.length>0)await i0(Q[0])});h.addEventListener("click",()=>{h0.click()});M0.addEventListener("click",()=>{if(T)T.start(),y(!0)});u0.addEventListener("click",()=>{if(T)T.stop(),y(!1)});y0.addEventListener("click",()=>{if(T)T.reset(),y(!1)});g0.addEventListener("click",()=>{if(T)T.step()});l0.addEventListener("click",()=>{if(T){let $=T.exportTrace();if($){let Q=new Blob([$],{type:"text/plain"}),J=URL.createObjectURL(Q),j=document.createElement("a");j.href=J,j.download="taiko_trace.txt",j.click(),URL.revokeObjectURL(J)}}});async function i0($){try{S0(null),f.innerHTML="<p>Loading file...</p>";let Q=await $.arrayBuffer();j6.textContent=`File: ${$.name} (${($.size/1024).toFixed(2)} KB)`,f.innerHTML="<p>Initializing emulator...</p>",T=new j0(W6,{enableTracing:Z6.checked}),await T.loadSysout(Q),f.innerHTML="<p>Emulator ready</p>",y(!1),U6()}catch(Q){S0(Q),f.innerHTML="<p>Error loading file</p>"}}function y($){M0.disabled=!T||$,u0.disabled=!T||!$,y0.disabled=!T,g0.disabled=!T||$,l0.disabled=!T||!T.hasTrace()}var _0=performance.now(),z0=0,P0=0;function U6(){function $(){if(T){let Q=T.getState();z6.textContent=`0x${Q.pc.toString(16)}`,K6.textContent=`0x${Q.sp.toString(16)}`,X6.textContent=`0x${Q.fp.toString(16)}`,z0++;let J=performance.now();if(J-_0>=1000)P0=z0,z0=0,_0=J;Y6.textContent=P0.toString(),y(Q.running)}requestAnimationFrame($)}requestAnimationFrame($)}function S0($){if($)W0.style.display="block",W0.innerHTML=`
            <h3>Error</h3>
            <pre>${$.message}
${$.stack}</pre>
        `;else W0.style.display="none"}y(!1);
